<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RideSync – NWA & U of A</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Stripe placeholder (real payments wired later) -->
  <script src="https://js.stripe.com/v3"></script>

  <!-- QR code library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1d4ed8, #020617 55%);
      color: #f9fafb;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 10px;
    }
    .card {
      background: rgba(2,6,23,0.92);
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.45);
      box-shadow: 0 24px 60px rgba(0,0,0,0.6);
      width: 100%;
      max-width: 520px;
      max-height: 96vh;
      padding: 22px 18px 18px;
      overflow-y: auto;
      position: relative;
      z-index: 2;
      backdrop-filter: blur(12px);
    }
    h1, h2 { margin: 0 0 8px; text-align: center; }
    h1 { font-size: 1.6rem; }
    h2 { font-size: 1.1rem; }
    .subtitle {
      margin: 0 0 18px;
      text-align: center;
      font-size: 0.85rem;
      color: #9ca3af;
    }
    label {
      font-size: 0.8rem;
      display: block;
      margin-bottom: 4px;
      color: #e5e7eb;
    }
    input, select {
      width: 100%;
      padding: 9px 11px;
      border-radius: 10px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #f9fafb;
      font-size: 0.9rem;
      margin-bottom: 10px;
    }
    input:focus, select:focus {
      outline: 2px solid #2563eb;
      outline-offset: 1px;
    }
    button {
      width: 100%;
      padding: 10px 12px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      margin-top: 4px;
    }
    .btn-primary { background: #22c55e; color: #022c22; }
    .btn-secondary {
      background: #020617;
      color: #e5e7eb;
      border: 1px solid #4b5563;
      margin-top: 8px;
    }
    .btn-small {
      width: auto;
      padding: 6px 10px;
      font-size: 0.8rem;
      border-radius: 999px;
    }
    .rider-action-box {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 14px;
    }
    .rider-action-header {
      font-size: 0.85rem;
      color: #cbd5f5;
      font-weight: 600;
    }
    .rider-action-buttons {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .rider-action-buttons button {
      width: auto;
      flex: 1 1 0%;
      margin-top: 0;
    }
    @media (min-width: 520px) {
      .rider-action-buttons {
        flex-direction: row;
      }
    }
    .row { display: flex; gap: 8px; flex-wrap: wrap; }
    .row > div { flex: 1 1 120px; }
    .section-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #9ca3af;
      margin: 14px 0 6px;
      border-top: 1px solid rgba(148,163,184,0.4);
      padding-top: 8px;
    }
    .toggle-auth {
      display: flex;
      justify-content: center;
      gap: 6px;
      font-size: 0.8rem;
      margin-bottom: 10px;
      color: #9ca3af;
    }
    .toggle-auth span { text-decoration: underline; cursor: pointer; }

    .error { color: #fecaca; font-size: 0.8rem; min-height: 18px; margin-bottom: 6px; }
    .success { color: #bbf7d0; font-size: 0.8rem; min-height: 18px; margin-bottom: 6px; }
    .small { font-size: 0.75rem; color: #9ca3af; margin-top: 4px; }

    #authView, #rideView, #loadingView { display: none; }
    #authView.active, #rideView.active, #loadingView.active { display: block; }

    #map {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
    }
    .fare-box {
      background: rgba(15,23,42,0.9);
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.5);
      padding: 9px 11px;
      font-size: 0.8rem;
      margin-bottom: 10px;
    }
    .trip-builder-card {
      display: flex;
      flex-direction: column;
      gap: 14px;
      padding: 14px;
    }
    .trip-builder-fields {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .trip-field {
      display: flex;
      flex-direction: column;
    }
    .trip-map-preview {
      position: relative;
      min-height: 180px;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.3);
      background: #020617;
      overflow: hidden;
    }
    .trip-map-canvas {
      position: absolute;
      inset: 0;
    }
    .map-empty-state {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 14px;
      text-align: center;
      font-size: 0.8rem;
      color: #94a3b8;
      background: linear-gradient(135deg, rgba(15,23,42,0.92), rgba(2,6,23,0.92));
      transition: opacity 0.25s ease;
    }
    .trip-map-preview.has-destination .map-empty-state {
      opacity: 0;
      pointer-events: none;
    }
    @media (min-width: 640px) {
      .trip-builder-card {
        flex-direction: row;
        align-items: stretch;
      }
      .trip-builder-fields,
      .trip-map-preview {
        flex: 1 1 0%;
      }
    }
    .fare-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 3px;
    }
    .fare-label { color: #9ca3af; }
    .fare-value { color: #e5e7eb; }
    .fare-total { color: #bbf7d0; font-weight: 600; }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid #4b5563;
      background: rgba(15,23,42,0.9);
      margin-top: 3px;
    }
    .badge-basic { border-color:#3b82f6; color:#bfdbfe; }
    .badge-uofa { border-color:#22c55e; color:#bbf7d0; }
    .badge-nwa { border-color:#f97316; color:#fed7aa; }
    .badge-tag { font-size: 0.68rem; color:#e5e7eb; opacity:0.8; }

    .rider-header {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }
    .rider-avatar {
      width: 60px;
      height: 60px;
      border-radius: 999px;
      border: 2px solid rgba(148,163,184,0.8);
      object-fit: cover;
      background: #020617;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: #9ca3af;
      font-size: 1.1rem;
      overflow: hidden;
    }
    .rider-header-text { flex: 1 1 auto; min-width: 0; }
    .rider-name { font-size: 1rem; font-weight: 600; }
    .rider-contact { font-size: 0.8rem; color: #9ca3af; }

    .rider-info-card {
      background: rgba(15,23,42,0.92);
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.5);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      margin-bottom: 12px;
    }
    .rider-info-main {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .rider-info-text {
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex: 1 1 auto;
    }
    .rider-info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
    }
    .rider-info-field {
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(2,6,23,0.85);
      padding: 10px 12px;
    }
    .rider-info-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #94a3b8;
      margin-bottom: 2px;
    }
    .rider-info-value {
      font-size: 0.9rem;
      color: #f9fafb;
      word-break: break-word;
    }
    .rider-info-actions {
      display: flex;
      justify-content: flex-end;
    }

    .membership-card {
      background: rgba(15,23,42,0.92);
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.45);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      margin-bottom: 16px;
    }
    .membership-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    .membership-subtitle {
      margin: 2px 0 0;
      font-size: 0.85rem;
      color: #9ca3af;
    }
    .membership-status-badge {
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .membership-status-badge.active {
      border-color: #22c55e;
      color: #bbf7d0;
    }
    .membership-status-badge.inactive {
      border-color: #f97316;
      color: #fed7aa;
    }
    .membership-status-badge.pending {
      border-color: #facc15;
      color: #fef3c7;
    }
    .membership-plan-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
    }
    .membership-plan {
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(2,6,23,0.85);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .membership-plan.active {
      border-color: #22c55e;
      background: rgba(34,197,94,0.08);
    }
    .membership-plan-title {
      font-weight: 600;
    }
    .membership-plan-price {
      font-size: 1rem;
      color: #f9fafb;
    }
    .membership-plan-desc {
      font-size: 0.78rem;
      color: #9ca3af;
      margin: 0;
    }
    .membership-plan button {
      margin-top: auto;
    }

    .payment-overlay {
      position: fixed;
      inset: 0;
      background: rgba(2,6,23,0.88);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 80;
    }
    .payment-overlay.active {
      display: flex;
    }
    .payment-panel {
      width: min(480px, 100%);
      background: rgba(15,23,42,0.95);
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.4);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      box-shadow: 0 30px 80px rgba(0,0,0,0.6);
    }
    .payment-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
    }
    .payment-panel-title {
      margin: 0;
      font-size: 1.2rem;
    }
    .payment-panel-subtitle {
      margin: 4px 0 0;
      font-size: 0.9rem;
      color: #9ca3af;
    }

    .top-right {
      position: fixed;
      right: 10px;
      top: 8px;
      font-size: 0.7rem;
      color: #cbd5f5;
      z-index: 3;
    }

    .loading-center {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 240px;
      text-align: center;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      border: 4px solid rgba(148,163,184,0.4);
      border-top-color: #22c55e;
      animation: spin 1s linear infinite;
      margin-bottom: 14px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(2,6,23,0.9);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 50;
    }
    .overlay.active { display: flex; }
    .rider-overlay-shell {
      width: min(520px, 100%);
      max-height: 100%;
      overflow-y: auto;
      background: rgba(2,6,23,0.95);
      border: 1px solid rgba(148,163,184,0.45);
      border-radius: 20px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      box-shadow: 0 30px 80px rgba(0,0,0,0.65);
    }
    .overlay-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 12px;
    }
    .overlay-title { font-size:1.2rem; font-weight:600; }
    .overlay-subtitle { font-size:0.85rem; color:#9ca3af; margin-top:2px; }
    .overlay-close {
      border-radius:999px;
      border:1px solid #4b5563;
      background:#020617;
      color:#e5e7eb;
      padding:6px 12px;
      cursor:pointer;
      font-size:0.82rem;
      flex-shrink: 0;
    }
    .rider-state {
      display: none;
      flex-direction: column;
      gap: 12px;
    }
    .rider-state.active { display: flex; }
    .state-text {
      font-size: 1rem;
      font-weight: 600;
    }
    .state-subtext {
      font-size: 0.9rem;
      color: #9ca3af;
    }
    .pin-card {
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.9);
      padding: 16px;
      text-align: center;
    }
    .pin-label {
      font-size: 0.9rem;
      color: #cbd5f5;
      margin-bottom: 6px;
    }
    .pin-value {
      font-size: 2.5rem;
      letter-spacing: 0.4rem;
      font-weight: 700;
      color: #f9fafb;
    }
    .pin-hint {
      font-size: 0.85rem;
      color: #9ca3af;
      margin-top: 6px;
    }
    .driver-info-slot {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .driver-info-stack {
      display: flex;
      flex-direction: column;
      gap: 14px;
      border: 1px solid rgba(148,163,184,0.5);
      border-radius: 18px;
      padding: 16px;
      background: rgba(2,6,23,0.95);
    }
    .driver-info-stack > :not(:first-child) {
      border-top: 1px solid rgba(148,163,184,0.25);
      padding-top: 14px;
    }
    .driver-identity-card,
    .driver-vehicle-card,
    .driver-license-card {
      border: none;
      border-radius: 0;
      padding: 0;
      background: transparent;
    }
    .support-panel {
      border: none;
      border-radius: 0;
      padding: 0;
      background: transparent;
    }
    .driver-identity-card {
      margin-top: 0;
    }
    .driver-identity-header {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .driver-identity-avatar {
      width: 64px;
      height: 64px;
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.7);
      overflow: hidden;
      background: #0f172a;
      position: relative;
      flex-shrink: 0;
    }
    .driver-identity-avatar img,
    .driver-vehicle-photo img,
    .driver-license-photo img,
    .eta-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }
    .avatar-fallback {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: #94a3b8;
      font-size: 0.9rem;
    }
    .driver-identity-meta { flex: 1 1 auto; min-width: 0; }
    .driver-identity-name-row {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
    }
    .driver-identity-name {
      font-size: 1rem;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .driver-rating-pill {
      font-size: 0.76rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(251,191,36,0.6);
      color: #fcd34d;
      background: rgba(120,53,15,0.25);
      display: none;
      white-space: nowrap;
    }
    .driver-identity-status {
      font-size: 0.78rem;
      color: #9ca3af;
      margin-top: 2px;
    }
    .driver-identity-phone {
      font-size: 0.82rem;
      color: #e5e7eb;
      margin-top: 4px;
    }
    .driver-identity-badges {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .driver-badge-pill {
      font-size: 0.7rem;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid rgba(94,234,212,0.5);
      color: #99f6e4;
      background: rgba(13,148,136,0.2);
    }
    .driver-vehicle-card,
    .driver-license-card {
      display: none;
    }
    .driver-vehicle-body,
    .driver-license-body {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .driver-vehicle-photo,
    .driver-license-photo {
      width: 96px;
      height: 72px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.5);
      overflow: hidden;
      background: #0f172a;
      position: relative;
      flex-shrink: 0;
    }
    .driver-vehicle-details,
    .driver-license-details {
      font-size: 0.82rem;
      color: #e5e7eb;
    }
    .driver-vehicle-name {
      font-weight: 600;
      margin-bottom: 2px;
    }
    .driver-license-card .driver-license-summary {
      font-weight: 600;
      margin-bottom: 2px;
    }
    .driver-license-meta {
      font-size: 0.75rem;
      color: #94a3b8;
    }
    .driver-identity-eta {
      font-size: 0.85rem;
      color: #cbd5f5;
      margin-top: 10px;
    }
    .driver-mini-map-shell {
      position: relative;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.35);
      margin-top: 12px;
      overflow: hidden;
      min-height: 180px;
      background: rgba(15,23,42,0.9);
      display: none;
    }
    .driver-mini-map {
      width: 100%;
      height: 200px;
    }
    .driver-mini-map-status {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      color: #cbd5f5;
      background: rgba(2,6,23,0.9);
      opacity: 0;
      transition: opacity 0.2s ease;
      pointer-events: none;
    }
    .driver-mini-map-shell.show-status .driver-mini-map-status {
      opacity: 1;
    }
    .support-panel {
      display: none;
      scroll-margin-top: 16px;
    }
    .support-panel.active {
      display: block;
    }
    .support-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    .support-panel-text {
      font-size: 0.82rem;
      color: #cbd5f5;
      margin-bottom: 10px;
    }
    .support-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .support-actions a {
      flex: 1 1 140px;
      text-align: center;
      text-decoration: none;
    }
    textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #f9fafb;
      font-size: 0.9rem;
      resize: vertical;
      min-height: 80px;
    }
    .rating-stars {
      display: flex;
      gap: 6px;
    }
    .rating-stars button {
      flex: 1 1 auto;
      border: 1px solid rgba(248,250,252,0.3);
      background: rgba(15,23,42,0.9);
      color: #fcd34d;
      font-size: 1.2rem;
      border-radius: 10px;
      padding: 8px 0;
      cursor: pointer;
    }
    .rating-stars button.active {
      background: #fcd34d;
      color: #1f2937;
    }
    .tip-options {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .tip-button {
      flex: 1 1 80px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      padding: 8px 0;
      cursor: pointer;
    }
    .tip-button.active {
      background: #22c55e;
      color: #022c22;
      border-color: #22c55e;
    }
    #tipCustomInput {
      margin-top: 6px;
      display: none;
    }
    .hidden {
      display: none !important;
    }
    .ride-view-tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    .ride-view-tab {
      flex: 1 1 120px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.85);
      color: #e2e8f0;
      padding: 8px 12px;
      font-size: 0.9rem;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s ease;
    }
    .ride-view-tab:hover:not(.active) {
      border-color: rgba(248,250,252,0.6);
      color: #f8fafc;
    }
    .ride-view-tab.active {
      background: #f97316;
      border-color: #f97316;
      color: #0f172a;
      font-weight: 600;
      box-shadow: 0 4px 16px rgba(249,115,22,0.35);
    }
    .ride-view-panel {
      display: none;
    }
    .ride-view-panel.active {
      display: block;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="top-right" id="loginStatus"></div>

  <div class="card">
    <!-- AUTH VIEW -->
    <div id="authView" class="active">
      <h1>RideSync</h1>
      <p class="subtitle">NWA • U of A • Private rides made simple</p>

      <div class="toggle-auth">
        <span id="toggleLink">New here? Create account</span>
      </div>

      <div id="authError" class="error"></div>

      <label for="email">Email</label>
      <input id="email" type="email" placeholder="you@example.com" autocomplete="email" />

      <label for="password">Password</label>
      <input id="password" type="password" placeholder="••••••••" autocomplete="current-password" />

      <!-- SIGNUP FIELDS -->
      <div id="signupFields" style="display:none;">
        <div class="section-title">Rider info</div>
        <label for="fullName">Full name</label>
        <input id="fullName" type="text" placeholder="Your legal name" />

        <div class="row">
          <div>
            <label for="gender">Gender</label>
            <select id="gender">
              <option value="">Select…</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="other">Other / Prefer not</option>
            </select>
          </div>
          <div>
            <label for="phoneNumber">Phone</label>
            <input id="phoneNumber" type="tel" placeholder="555-123-4567" />
          </div>
        </div>

        <div class="section-title">Address</div>
        <label for="streetAddress">Street</label>
        <input id="streetAddress" type="text" placeholder="123 Main St" />

        <div class="row">
          <div>
            <label for="city">City</label>
            <input id="city" type="text" placeholder="Fayetteville" />
          </div>
          <div>
            <label for="state">State</label>
            <input id="state" type="text" placeholder="AR" />
          </div>
          <div>
            <label for="zip">ZIP</label>
            <input id="zip" type="text" placeholder="72701" />
          </div>
        </div>

        <div class="section-title">Student & membership</div>
        <div class="row">
          <div>
            <label for="isStudent">U of A student?</label>
            <select id="isStudent">
              <option value="false">No</option>
              <option value="true">Yes</option>
            </select>
          </div>
          <div>
            <label for="membership">Membership</label>
            <select id="membership">
              <option value="basic">Basic (pay per ride)</option>
              <option value="uofa_unlimited">U of A Unlimited ($80/mo)</option>
              <option value="nwa_unlimited">NWA Unlimited ($120/mo)</option>
            </select>
          </div>
        </div>

        <div class="section-title">Photos (never public)</div>
        <label>Profile picture</label>
        <input id="profilePicInput" type="file" accept="image/*" />
        <label>Driver license</label>
        <input id="licensePicInput" type="file" accept="image/*" />
        <label>Student ID</label>
        <input id="studentIdPicInput" type="file" accept="image/*" />
      </div>

      <button id="authButton" class="btn-primary">Log in</button>
      <p class="small">When creating an account, all info on this screen saves at once.</p>
    </div>

    <!-- RIDE VIEW -->
    <div id="rideView">
      <div class="ride-view-tabs" role="tablist" aria-label="Rider sections">
        <button
          type="button"
          id="rideViewTabDestination"
          class="ride-view-tab active"
          data-view-tab="destination"
          aria-controls="rideViewPanelDestination"
          aria-selected="true"
          tabindex="0"
        >
          Destination
        </button>
        <button
          type="button"
          id="rideViewTabMembership"
          class="ride-view-tab"
          data-view-tab="membership"
          aria-controls="rideViewPanelMembership"
          aria-selected="false"
          tabindex="-1"
        >
          Membership
        </button>
        <button
          type="button"
          id="rideViewTabInfo"
          class="ride-view-tab"
          data-view-tab="info"
          aria-controls="rideViewPanelInfo"
          aria-selected="false"
          tabindex="-1"
        >
          Rider info
        </button>
      </div>

      <div id="profileMessage" class="success"></div>
      <div id="profileError" class="error"></div>

      <div
        class="ride-view-panel active"
        id="rideViewPanelDestination"
        data-view-panel="destination"
        role="tabpanel"
        aria-labelledby="rideViewTabDestination"
        aria-hidden="false"
      >
      <!-- Join banner for QR joiners -->
      <div id="joinBanner" class="fare-box" style="display:none;">
        <div class="small" id="joinBannerText"></div>
      </div>

      <div class="section-title">Trip setup</div>
      <div class="small" style="margin: -4px 0 12px; color: #94a3b8;">
        Check out our memberships to save on frequent rides.
      </div>
      <div class="fare-box trip-builder-card">
        <div class="trip-builder-fields">
          <div class="trip-field">
            <label for="destination">Where are you going?</label>
            <input id="destination" type="text" placeholder="Enter destination address" />
          </div>
          <div id="ridersSection" class="trip-field">
            <label for="numRiders">Number of riders</label>
            <select id="numRiders">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
            </select>
            <div class="small">
              For U of A pooling, choose 1 rider. For private group rides with friends, choose 2–4 and use the QR.
            </div>
          </div>
        </div>
        <div id="tripMapPreview" class="trip-map-preview" aria-hidden="true">
          <div id="destinationPreviewMap" class="trip-map-canvas"></div>
          <div id="destinationPreviewEmpty" class="map-empty-state">
            Add a destination to preview your pickup &amp; dropoff pins.
          </div>
        </div>
      </div>

      <div class="section-title" id="poolGroupTitle" style="display:none;">
        U of A pool group
      </div>
      <div id="poolGroupBox" class="fare-box" style="display:none;">
        <div class="small" id="poolGroupStatus">
          Searching for other U of A riders…
        </div>
        <div id="poolGroupList"></div>
      </div>

      <div class="section-title">Estimated fare</div>
      <div class="fare-box">
        <div id="fareNotReady" class="small">
          Set a destination to see estimated time, distance, and total.
        </div>
        <div id="fareReady" style="display:none;">
          <div class="fare-row">
            <div class="fare-label">Time</div>
            <div class="fare-value" id="fareTime"></div>
          </div>
          <div class="fare-row">
            <div class="fare-label">Distance</div>
            <div class="fare-value" id="fareDistance"></div>
          </div>
          <div class="fare-row">
            <div class="fare-label">Plan</div>
            <div class="fare-value" id="fareMembership"></div>
          </div>
          <div class="fare-row">
            <div class="fare-label">Total (incl. fees)</div>
            <div class="fare-total" id="fareTotal"></div>
          </div>
        </div>
      </div>

      <div class="fare-box rider-action-box">
        <div class="rider-action-header">Account &amp; ride actions</div>
        <div class="rider-action-buttons">
          <button id="syncButton" class="btn-primary">Sync &amp; Pay</button>
          <button id="logoutButton" class="btn-secondary">Log out</button>
        </div>
      </div>
      </div>

      <div
        class="ride-view-panel"
        id="rideViewPanelMembership"
        data-view-panel="membership"
        role="tabpanel"
        aria-labelledby="rideViewTabMembership"
        aria-hidden="true"
      >
        <div id="membershipCard" class="membership-card">
          <div class="membership-card-header">
            <div>
              <div
                class="section-title"
                style="margin-top:0;border-top:none;padding-top:0;"
              >
                Membership
              </div>
              <p id="membershipStatusText" class="membership-subtitle">
                Loading membership…
              </p>
            </div>
            <span id="membershipStatusBadge" class="membership-status-badge">—</span>
          </div>
          <!-- === RIDE SYNC STRIPE: START membership summary === -->
          <div class="membership-card-summary">
            <p id="membershipCurrentLabel" class="membership-subtitle">
              Checking membership...
            </p>
            <div class="rider-info-actions" style="margin-top:8px;">
              <button
                id="membershipChangeButton"
                type="button"
                class="btn-secondary btn-small"
              >
                Change membership
              </button>
            </div>
          </div>
          <!-- === RIDE SYNC STRIPE: END membership summary === -->
          <div class="membership-plan-grid" style="display:none;">
            <div class="membership-plan" data-plan="basic">
              <div class="membership-plan-title">Basic</div>
              <div class="membership-plan-price" data-plan-price="basic">
                $0 / ride
              </div>
              <p class="membership-plan-desc">
                Pay per ride with Stripe. Best if you only ride occasionally.
              </p>
              <button
                class="btn-secondary btn-small"
                type="button"
                data-plan-action="basic"
              >
                Stay on Basic
              </button>
            </div>
            <div class="membership-plan" data-plan="uofa_unlimited">
              <div class="membership-plan-title">U of A Unlimited</div>
              <div
                class="membership-plan-price"
                data-plan-price="uofa_unlimited"
              >
                $80 / month
              </div>
              <p class="membership-plan-desc">
                Unlimited Fayetteville rides. Out-of-zone trips bill per minute.
              </p>
              <button
                class="btn-primary btn-small"
                type="button"
                data-plan-action="uofa_unlimited"
              >
                Upgrade to U of A Unlimited
              </button>
            </div>
            <div class="membership-plan" data-plan="nwa_unlimited">
              <div class="membership-plan-title">NWA Unlimited</div>
              <div
                class="membership-plan-price"
                data-plan-price="nwa_unlimited"
              >
                $120 / month
              </div>
              <p class="membership-plan-desc">
                Unlimited rides inside the 30-mile NWA radius.
              </p>
              <button
                class="btn-primary btn-small"
                type="button"
                data-plan-action="nwa_unlimited"
              >
                Upgrade to NWA Unlimited
              </button>
            </div>
          </div>
          <div id="membershipCardMessage" class="small"></div>
        </div>
      </div>

      <div
        class="ride-view-panel"
        id="rideViewPanelInfo"
        data-view-panel="info"
        role="tabpanel"
        aria-labelledby="rideViewTabInfo"
        aria-hidden="true"
      >
      <div id="riderInfoCard" class="rider-info-card">
        <div class="rider-info-main">
          <div id="avatar" class="rider-avatar">RS</div>
          <div class="rider-info-text">
            <div class="rider-name" id="riderName">Rider</div>
            <div id="membershipBadge" class="badge badge-basic">
              <span id="membershipBadgeLabel">Basic</span>
              <span class="badge-tag" id="membershipBadgeTag"></span>
            </div>
          </div>
        </div>

        <div class="rider-info-grid">
          <div class="rider-info-field">
            <div class="rider-info-label">Email</div>
            <div class="rider-info-value" id="riderEmailDetail">you@example.com</div>
          </div>
          <div class="rider-info-field">
            <div class="rider-info-label">Phone</div>
            <div class="rider-info-value" id="riderPhoneDetail"></div>
          </div>
          <div class="rider-info-field">
            <div class="rider-info-label">Address</div>
            <div class="rider-info-value" id="riderAddressDetail"></div>
          </div>
          <div class="rider-info-field">
            <div class="rider-info-label">Membership</div>
            <div class="rider-info-value" id="riderMembershipDetail"></div>
          </div>
        </div>

        <div class="rider-info-actions">
          <button
            id="editProfileButton"
            type="button"
            class="btn-secondary btn-small"
          >
            Edit profile
          </button>
        </div>
      </div>

      <!-- Inline edit form -->
      <div id="editProfileSection"
           class="fare-box"
           style="display:none; margin-top:6px;">
        <div class="row">
          <div>
            <label for="editFullName">Name</label>
            <input id="editFullName" type="text" />
          </div>
          <div>
            <label for="editPhone">Phone</label>
            <input id="editPhone" type="tel" />
          </div>
          <div>
            <label for="editGender">Gender</label>
            <select id="editGender">
              <option value="">Select…</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="other">Other / Prefer not</option>
            </select>
          </div>
        </div>

        <label for="editStreet">Street</label>
        <input id="editStreet" type="text" />

        <div class="row">
          <div>
            <label for="editCity">City</label>
            <input id="editCity" type="text" />
          </div>
          <div>
            <label for="editState">State</label>
            <input id="editState" type="text" />
          </div>
          <div>
            <label for="editZip">ZIP</label>
            <input id="editZip" type="text" />
          </div>
        </div>

        <div class="section-title">Photos</div>
        <label>Profile picture</label>
        <input id="editProfilePicInput" type="file" accept="image/*" />
        <label>Driver license</label>
        <input id="editLicensePicInput" type="file" accept="image/*" />
        <label>Student ID</label>
        <input id="editStudentIdPicInput" type="file" accept="image/*" />

        <button id="saveProfileButton" type="button"
                class="btn-primary btn-small"
                style="margin-top:8px;">
          Save changes
        </button>
      </div>

      </div>
    </div>

    <!-- LOADING VIEW -->
      <div id="loadingView">
        <h2>RideSync</h2>
        <div class="loading-center">
          <div class="loading-spinner"></div>
          <div>Syncing your ride…</div>
          <div class="small">Pre-authorizing payment and matching your driver.</div>
        </div>
      </div>

      <!-- RIDE SUMMARY (after ride completes) -->
      <div id="rideSummary" style="display:none; color:#e5e7eb; padding:16px 4px; text-align:center;">
        <h2 style="margin-bottom:8px;">Ride complete</h2>
        <div id="rideSummaryText" style="font-size:0.85rem; line-height:1.4;"></div>
      </div>

      <!-- RIDER ACTIVE RIDE OVERLAY -->
      <div id="riderOverlay" class="overlay">
        <div class="rider-overlay-shell">
          <div class="overlay-header">
            <div>
              <div id="riderOverlayTitle" class="overlay-title">RideSync</div>
              <div id="riderOverlaySubtitle" class="overlay-subtitle"></div>
            </div>
          </div>

          <div id="riderStateSearching" class="rider-state">
            <div class="loading-spinner"></div>
            <div class="state-text">Looking for a driver…</div>
            <div class="state-subtext">We’re syncing you with a nearby verified driver.</div>
          </div>

          <div id="riderStateDriverEta" class="rider-state">
            <div class="state-text">Driver accepted</div>
            <div class="state-subtext">Track their ETA and vehicle details below.</div>
            <div class="driver-info-slot" data-slot="driver"></div>
          </div>

          <div id="riderStatePickupPin" class="rider-state">
            <div class="state-text">Share your pickup code</div>
            <div class="pin-card">
              <div class="pin-label">Tell your driver this code when they arrive</div>
              <div id="riderPickupPinValue" class="pin-value">----</div>
              <div class="pin-hint">We use codes so only verified rides start.</div>
            </div>
          </div>

          <div id="riderStateInTrip" class="rider-state">
            <div class="state-text">On the way</div>
            <div id="riderTripEtaText" class="state-subtext"></div>
            <div class="driver-info-slot" data-slot="driver"></div>
          </div>

          <div id="riderStateDropoffPin" class="rider-state">
            <div class="state-text">Almost there</div>
            <div class="pin-card">
              <div class="pin-label">Share this code at dropoff</div>
              <div id="riderDropoffPinValue" class="pin-value">----</div>
              <div class="pin-hint">Your driver enters this to finish the ride.</div>
            </div>
          </div>

          <div id="riderStateRateTip" class="rider-state">
            <div class="state-text">Rate your ride</div>
            <div id="ratingStars" class="rating-stars">
              <button type="button" data-rating="1">★</button>
              <button type="button" data-rating="2">★</button>
              <button type="button" data-rating="3">★</button>
              <button type="button" data-rating="4">★</button>
              <button type="button" data-rating="5">★</button>
            </div>
            <textarea id="riderFeedbackInput" placeholder="Anything we should know?"></textarea>
            <div class="state-text">Tip your driver</div>
            <div id="tipOptions" class="tip-options">
              <button type="button" class="tip-button active" data-tip="0">$0</button>
              <button type="button" class="tip-button" data-tip="2">$2</button>
              <button type="button" class="tip-button" data-tip="5">$5</button>
              <button type="button" class="tip-button" data-tip="10">$10</button>
              <button type="button" class="tip-button tip-custom" data-tip="custom">Custom</button>
            </div>
            <input id="tipCustomInput" type="number" min="0" step="1" placeholder="Custom tip" />
            <button id="submitRatingButton" class="btn-primary" type="button">Submit</button>
            <div id="ratingError" class="error"></div>
          </div>

          <div id="riderStateThanks" class="rider-state">
            <div class="state-text">Thank you for riding with RideSync!</div>
            <div class="state-subtext">You’re all set. Request another ride anytime.</div>
          </div>

          <div id="driverInfoStack" class="driver-info-stack">
            <div id="driverIdentityCard" class="driver-identity-card">
              <div class="driver-identity-header">
                <div class="driver-identity-avatar">
                  <img id="driverIdentityAvatarImg" alt="Driver avatar" />
                  <div id="driverIdentityAvatarFallback" class="avatar-fallback">RS</div>
                </div>
                <div class="driver-identity-meta">
                  <div class="driver-identity-name-row">
                    <div id="driverIdentityName" class="driver-identity-name">RideSync driver</div>
                    <div id="driverIdentityRating" class="driver-rating-pill"></div>
                  </div>
                  <div id="driverIdentityStatus" class="driver-identity-status"></div>
                  <div id="driverIdentityPhoneRow" class="driver-identity-phone">
                    <span id="driverIdentityPhone"></span>
                  </div>
                </div>
              </div>
              <div id="driverIdentityBadges" class="driver-identity-badges"></div>
              <div id="driverIdentityEta" class="driver-identity-eta"></div>
              <div id="driverMiniMapShell" class="driver-mini-map-shell">
                <div id="driverMiniMap" class="driver-mini-map"></div>
                <div id="driverMiniMapStatus" class="driver-mini-map-status">
                  Waiting for driver location…
                </div>
              </div>
            </div>

            <div id="driverVehicleSection" class="driver-vehicle-card">
              <div class="section-title" style="margin-top:0;">Vehicle</div>
              <div class="driver-vehicle-body">
                <div class="driver-vehicle-photo">
                  <img id="driverVehiclePhoto" alt="Driver vehicle" />
                  <div id="driverVehicleFallback" class="avatar-fallback">RS</div>
                </div>
                <div class="driver-vehicle-details">
                  <div id="driverVehicleName" class="driver-vehicle-name"></div>
                  <div id="driverVehiclePlate"></div>
                  <div id="driverVehicleNote" class="driver-license-meta"></div>
                </div>
              </div>
            </div>

            <div id="driverLicenseSection" class="driver-license-card">
              <div class="section-title" style="margin-top:0;">License &amp; verification</div>
              <div class="driver-license-body">
                <div class="driver-license-photo">
                  <img id="driverLicensePhoto" alt="Driver license" />
                  <div id="driverLicenseFallback" class="avatar-fallback">ID</div>
                </div>
                <div class="driver-license-details">
                  <div id="driverLicenseSummary" class="driver-license-summary"></div>
                  <div id="driverLicenseMeta" class="driver-license-meta"></div>
                </div>
              </div>
            </div>

            <button id="contactDriverBtn" type="button" class="btn-secondary" style="margin-top:8px;">
              Support
            </button>

            <div id="supportPanel" class="support-panel">
              <div class="support-panel-header">
                <div style="font-weight:600;">RideSync support</div>
                <button id="supportBackButton" type="button" class="btn-small btn-secondary">Back</button>
              </div>
              <div class="support-panel-text">
                Choose how you'd like to contact RideSync support.
              </div>
              <div class="support-actions">
                <a id="supportCallButton" class="btn-primary" href="#" role="button">Call support</a>
                <a id="supportTextButton" class="btn-secondary" href="#" role="button">Text support</a>
              </div>
            </div>
          </div>

          <div id="riderOverlayError" class="error"></div>
        </div>
      </div>

        <!-- QR section for private group rides -->
        <div id="groupQrSection" style="display:none; margin-top:14px;">
          <div class="small">
            Riding with friends? Ask each of them to scan this QR and sign in to join this ride.
          </div>
          <canvas id="groupQrCanvas"
                  width="140"
                  height="140"
                  style="margin-top:8px;"></canvas>
          <div id="groupOccupancyLabel" class="small" style="margin-top:6px;"></div>
        </div>

        <button id="cancelRideButton" class="btn-secondary" style="margin-top:16px;" hidden>
          Cancel ride
        </button>
        <div id="cancelError" class="error"></div>
      </div>
    </div>
  </div>

  <div id="paymentOverlay" class="payment-overlay" aria-hidden="true">
    <div class="payment-panel">
      <div class="payment-panel-header">
        <div>
          <h3 id="paymentOverlayTitle" class="payment-panel-title">
            Complete payment
          </h3>
          <p id="paymentOverlaySubtitle" class="payment-panel-subtitle"></p>
        </div>
        <button
          id="paymentOverlayClose"
          type="button"
          class="btn-secondary btn-small"
        >
          Cancel
        </button>
      </div>
      <div id="paymentElement"></div>
      <button
        id="paymentOverlayConfirm"
        type="button"
        class="btn-primary"
      >
        Pay now
      </button>
      <div id="paymentOverlayMessage" class="error"></div>
    </div>
  </div>

  <!-- === RIDE SYNC STRIPE: START membership selection overlay === -->
  <div
    id="membershipSelectionOverlay"
    class="overlay"
    aria-hidden="true"
    inert
  >
    <div class="payment-panel">
      <div class="payment-panel-header">
        <h3>Select membership</h3>
        <button
          id="membershipSelectionClose"
          type="button"
          class="btn-secondary btn-small"
          data-default-focus="true"
        >
          Close
        </button>
      </div>
      <p class="membership-subtitle">
        Choose the unlimited plan that matches your coverage zone.
      </p>
      <div class="membership-plan-grid" style="margin-top:12px;">
        <div
          class="membership-plan"
          data-membership-option="uofa_unlimited"
        >
          <div class="membership-plan-title">U of A Unlimited</div>
          <div class="membership-plan-price">$80 / month</div>
          <p class="membership-plan-desc">
            Unlimited Fayetteville rides. Out-of-zone trips bill a surcharge.
          </p>
        </div>
        <div
          class="membership-plan"
          data-membership-option="nwa_unlimited"
        >
          <div class="membership-plan-title">NWA Unlimited</div>
          <div class="membership-plan-price">$120 / month</div>
          <p class="membership-plan-desc">
            Unlimited rides inside the 30-mile NWA radius.
          </p>
        </div>
      </div>
      <div id="membershipSelectionError" class="error"></div>
      <button
        id="membershipSelectionContinue"
        type="button"
        class="btn-primary"
        style="margin-top:12px;"
      >
        Continue
      </button>
      <button
        id="membershipSelectionBasic"
        type="button"
        class="btn-secondary btn-small"
        style="margin-top:8px;"
      >
        Switch to Basic
      </button>
    </div>
  </div>
  <!-- === RIDE SYNC STRIPE: END membership selection overlay === -->

  <!-- === RIDE SYNC STRIPE: START membership terms overlay === -->
  <div id="membershipTermsOverlay" class="overlay" aria-hidden="true" inert>
    <div class="payment-panel">
      <div class="payment-panel-header">
        <h3>Membership terms</h3>
        <button
          id="membershipTermsClose"
          type="button"
          class="btn-secondary btn-small"
          data-default-focus="true"
        >
          Close
        </button>
      </div>
      <div class="fare-box" style="max-height:40vh;overflow:auto;">
        <p>
          These membership terms describe unlimited ride coverage, billing
          schedule, and cancellation policies. Review the full details before
          accepting. (Placeholder copy – update anytime.)
        </p>
        <ul style="padding-left:18px;line-height:1.6;">
          <li>Monthly dues bill immediately via Stripe.</li>
          <li>Unlimited zone rides are included; surcharges apply outside.</li>
          <li>Cancel anytime; billing stops at the next cycle.</li>
        </ul>
      </div>
      <label style="display:flex;align-items:center;gap:8px;margin-top:12px;">
        <input id="membershipTermsCheckbox" type="checkbox" />
        <span>I have read and agree to the Membership Terms.</span>
      </label>
      <div style="margin-top:12px;">
        <div class="membership-subtitle" style="margin-bottom:6px;">
          Signature
        </div>
        <canvas
          id="membershipSignatureCanvas"
          width="600"
          height="180"
          style="
            width:100%;
            height:180px;
            border:1px dashed rgba(148,163,184,0.5);
            border-radius:12px;
            background:#0f172a;
          "
        ></canvas>
        <button
          id="membershipSignatureClear"
          type="button"
          class="btn-secondary btn-small"
          style="margin-top:8px;"
        >
          Clear signature
        </button>
      </div>
      <button
        id="membershipTermsAccept"
        type="button"
        class="btn-primary"
        style="margin-top:12px;"
        disabled
      >
        Accept & continue to payment
      </button>
      <div id="membershipTermsError" class="error"></div>
    </div>
  </div>
  <!-- === RIDE SYNC STRIPE: END membership terms overlay === -->

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      collection,
      addDoc,
      serverTimestamp,
      onSnapshot,
      query,
      where,
      getDocs,
      orderBy,
      limit,
      updateDoc,
      runTransaction
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-storage.js";
    import {
      getFunctions,
      httpsCallable
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-functions.js";

    async function loadAppConfig() {
      if (window.__rideSyncConfigPromise) {
        return window.__rideSyncConfigPromise;
      }

      window.__rideSyncConfigPromise = fetch("/app-config.json", {
        cache: "no-store"
      })
        .then((res) => {
          if (!res.ok) {
            throw new Error(`Failed to load app config: ${res.status}`);
          }
          return res.json();
        })
        .catch((err) => {
          console.error("App config load failed", err);
          throw err;
        });

      return window.__rideSyncConfigPromise;
    }

    function loadGoogleMapsSdk({ apiKey, libraries = [] } = {}) {
      if (window.__rideSyncMapsPromise) {
        return window.__rideSyncMapsPromise;
      }

      window.__rideSyncMapsPromise = new Promise((resolve, reject) => {
        if (window.google && window.google.maps) {
          resolve(window.google.maps);
          return;
        }

        if (!apiKey) {
          reject(new Error("Missing Google Maps API key"));
          return;
        }

        const params = new URLSearchParams({ key: apiKey });
        if (libraries.length) {
          params.set("libraries", libraries.join(","));
        }

        const script = document.createElement("script");
        script.src = `https://maps.googleapis.com/maps/api/js?${params.toString()}`;
        script.async = true;
        script.defer = true;
        script.onload = () => {
          if (window.google && window.google.maps) {
            resolve(window.google.maps);
          } else {
            reject(new Error("Google Maps SDK loaded without maps namespace."));
          }
        };
        script.onerror = () => reject(new Error("Google Maps SDK failed to load."));
        document.head.appendChild(script);
      }).catch((err) => {
        window.__rideSyncMapsPromise = null;
        throw err;
      });

      return window.__rideSyncMapsPromise;
    }

    function loadStripeJs() {
      if (!STRIPE_ENABLED) {
        return Promise.reject(
          new Error("Stripe payments are not available right now.")
        );
      }
      if (window.Stripe) {
        return Promise.resolve(window.Stripe);
      }
      if (!stripeJsPromise) {
        stripeJsPromise = new Promise((resolve, reject) => {
          const script = document.createElement("script");
          script.src = STRIPE_JS_URL;
          script.async = true;
          script.onload = () => {
            if (window.Stripe) {
              resolve(window.Stripe);
            } else {
              reject(
                new Error("Stripe.js loaded but Stripe was unavailable.")
              );
            }
          };
          script.onerror = () =>
            reject(new Error("Stripe.js failed to load."));
          document.head.appendChild(script);
        }).catch((err) => {
          stripeJsPromise = null;
          throw err;
        });
      }
      return stripeJsPromise;
    }

    const APP_CONFIG = await loadAppConfig();
    const firebaseConfig = APP_CONFIG.firebaseConfig || {};
    const supportConfig = APP_CONFIG.support || {};
    const geoConfig = APP_CONFIG.geo || {};
    const ridePolicyConfig = APP_CONFIG.ridePolicy || {};
    const placeholderConfig = APP_CONFIG.placeholders || {};
    const mapsConfig = APP_CONFIG.maps || APP_CONFIG.googleMaps || {};
    const DEFAULT_MAPS_API_KEY = "AIzaSyDlYSl5rfovahECuBSbkELw2uyC6-Ucmr0";
    const mapsApiKey = mapsConfig.apiKey || DEFAULT_MAPS_API_KEY;
    const mapsLibraries =
      Array.isArray(mapsConfig.libraries) && mapsConfig.libraries.length
        ? mapsConfig.libraries
        : ["places"];
    let googleMapsLoadFailed = false;

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const functionsClient = getFunctions(app);

    const stripeConfig = APP_CONFIG.stripe || {};
    const fareConfig = APP_CONFIG.fares || {};
    const functionsConfig = APP_CONFIG.functions || {};
    const STRIPE_PUBLISHABLE_KEY = stripeConfig.publishableKey || "";
    const stripeMembershipConfig = stripeConfig.membershipPlans || {};
    const STRIPE_ENABLED = !!STRIPE_PUBLISHABLE_KEY;
    const STRIPE_JS_URL = "https://js.stripe.com/v3/";
    const APPLY_MEMBERSHIP_PLAN_URL =
      functionsConfig.applyMembershipPlanUrl ||
      "https://us-central1-ride-sync-nwa.cloudfunctions.net/applyMembershipPlanHttp";

    const applyMembershipPlanFn = httpsCallable(
      functionsClient,
      "applyMembershipPlan"
    );
    const createMembershipSubscriptionIntentFn = httpsCallable(
      functionsClient,
      "createMembershipSubscriptionIntent"
    );
    const finalizeMembershipSubscriptionFn = httpsCallable(
      functionsClient,
      "finalizeMembershipSubscription"
    );
    const createRidePaymentIntentFn = httpsCallable(
      functionsClient,
      "createRidePaymentIntent"
    );
    const finalizeRidePaymentFn = httpsCallable(
      functionsClient,
      "finalizeRidePayment"
    );

    const NWA_CENTER = geoConfig.nwaCenter || { lat: 36.334, lng: -94.118 };
    const NWA_RADIUS_MILES = geoConfig.nwaRadiusMiles ?? 30;
    const UNLIMITED_COOLDOWN_MINUTES =
      ridePolicyConfig.unlimitedCooldownMinutes ?? 30;
    const SURGE_MODE = ridePolicyConfig.surgeMode ?? false;
    const SURGE_COOLDOWN_MINUTES =
      ridePolicyConfig.surgeCooldownMinutes ?? 60;
    const DRIVER_PLACEHOLDER_AVATAR = placeholderConfig.driverAvatar || "";
    const VEHICLE_PLACEHOLDER_IMG = placeholderConfig.vehicleImage || "";
    const LICENSE_PLACEHOLDER_IMG = placeholderConfig.licenseImage || "";
    const SUPPORT_PHONE_NUMBER = supportConfig.phoneNumber || "";
    const SUPPORT_TEL_LINK = SUPPORT_PHONE_NUMBER
      ? `tel:${SUPPORT_PHONE_NUMBER}`
      : "#";
    const SUPPORT_SMS_LINK = SUPPORT_PHONE_NUMBER
      ? `sms:${SUPPORT_PHONE_NUMBER}`
      : "#";
    const MEMBERSHIP_PLAN_COPY = {
      basic: {
        label: "Basic",
        price: "$0 / ride",
        description: "Pay per ride with Stripe.",
      },
      uofa_unlimited: {
        label: "U of A Unlimited",
        price: "$80 / month",
        description: "Unlimited Fayetteville rides.",
      },
      nwa_unlimited: {
        label: "NWA Unlimited",
        price: "$120 / month",
        description: "Unlimited rides inside the 30-mile NWA radius.",
      },
    };
    const MEMBERSHIP_PLAN_KEY_ALIASES = {
      basic: new Set(["basic", "basic (pay per ride)", "basic plan", "plan: basic"]),
    };

    const DEFAULT_FARE_SETTINGS = {
      BASIC_RATE_PER_MIN: 0.6,
      BASIC_PLATFORM_FEE: 0.5,
      BASIC_PROCESSING_FEE_RATE: 0.03,
      UNLIMITED_OUT_RATE: 0.35,
      UNLIMITED_PROCESSING_FEE_RATE: 0.04
    };

    function coerceFareNumber(value, fallback) {
      if (value === null || value === undefined) {
        return fallback;
      }
      if (typeof value === "string" && value.trim() === "") {
        return fallback;
      }
      const num = Number(value);
      return Number.isFinite(num) && num >= 0 ? num : fallback;
    }

    const FARE_SETTINGS = {
      BASIC_RATE_PER_MIN: coerceFareNumber(
        fareConfig.basicRatePerMin,
        DEFAULT_FARE_SETTINGS.BASIC_RATE_PER_MIN
      ),
      BASIC_PLATFORM_FEE: coerceFareNumber(
        fareConfig.basicPlatformFee,
        DEFAULT_FARE_SETTINGS.BASIC_PLATFORM_FEE
      ),
      BASIC_PROCESSING_FEE_RATE: coerceFareNumber(
        fareConfig.basicProcessingFeeRate,
        DEFAULT_FARE_SETTINGS.BASIC_PROCESSING_FEE_RATE
      ),
      UNLIMITED_OUT_RATE: coerceFareNumber(
        fareConfig.unlimitedOutRate,
        DEFAULT_FARE_SETTINGS.UNLIMITED_OUT_RATE
      ),
      UNLIMITED_PROCESSING_FEE_RATE: coerceFareNumber(
        fareConfig.unlimitedProcessingFeeRate,
        DEFAULT_FARE_SETTINGS.UNLIMITED_PROCESSING_FEE_RATE
      )
    };

    const urlParams = new URLSearchParams(window.location.search);
    const joinRideIdFromUrl = urlParams.get("join");
    let joinMode = false;
    let joinTargetRide = null;

    const PIN_CHARSET = "0123456789";
    const POOL_GENDER_ALLOWLIST = new Set(["male", "female"]);

    function normalizePoolGender(value) {
      if (typeof value !== "string") {
        return null;
      }
      const normalized = value.trim().toLowerCase();
      return POOL_GENDER_ALLOWLIST.has(normalized) ? normalized : null;
    }

    function generateRidePin(length = 4) {
      let code = "";
      for (let i = 0; i < length; i += 1) {
        const idx = Math.floor(Math.random() * PIN_CHARSET.length);
        code += PIN_CHARSET.charAt(idx);
      }
      return code;
    }

    let lastDestinationPlace = null;
    let lastDestinationIsFayetteville = false;

    function isFayettevilleFromPlace(place) {
      if (!place || !place.address_components) return false;
      return place.address_components.some(
        (comp) =>
          comp.types.includes("locality") && comp.long_name === "Fayetteville"
      );
    }

    const authView = document.getElementById("authView");
    const rideView = document.getElementById("rideView");
    const loadingView = document.getElementById("loadingView");
    const loginStatusEl = document.getElementById("loginStatus");
    const toggleLink = document.getElementById("toggleLink");
    const authError = document.getElementById("authError");
    const authButton = document.getElementById("authButton");
    const emailEl = document.getElementById("email");
    const passwordEl = document.getElementById("password");
    const signupFields = document.getElementById("signupFields");
    const fullNameEl = document.getElementById("fullName");
    const genderEl = document.getElementById("gender");
    const phoneEl = document.getElementById("phoneNumber");
    const streetEl = document.getElementById("streetAddress");
    const cityEl = document.getElementById("city");
    const stateEl = document.getElementById("state");
    const zipEl = document.getElementById("zip");
    const isStudentEl = document.getElementById("isStudent");
    const membershipEl = document.getElementById("membership");
    const profilePicInput = document.getElementById("profilePicInput");
    const licensePicInput = document.getElementById("licensePicInput");
    const studentIdPicInput = document.getElementById("studentIdPicInput");

    const avatarEl = document.getElementById("avatar");
    const riderNameEl = document.getElementById("riderName");
    const membershipBadgeEl = document.getElementById("membershipBadge");
    const membershipBadgeLabelEl = document.getElementById("membershipBadgeLabel");
    const membershipBadgeTagEl = document.getElementById("membershipBadgeTag");
    const membershipCard = document.getElementById("membershipCard");
    const membershipStatusText = document.getElementById("membershipStatusText");
    const membershipStatusBadge = document.getElementById("membershipStatusBadge");
    const membershipCardMessage = document.getElementById("membershipCardMessage");
    const membershipCurrentLabel = document.getElementById("membershipCurrentLabel");
    const membershipChangeButton = document.getElementById("membershipChangeButton");
    const membershipPriceEls = document.querySelectorAll("[data-plan-price]");
    const membershipSelectionOverlay = document.getElementById("membershipSelectionOverlay");
    const membershipSelectionClose = document.getElementById("membershipSelectionClose");
    const membershipSelectionOptions = document.querySelectorAll(
      "[data-membership-option]"
    );
    const membershipSelectionContinue = document.getElementById(
      "membershipSelectionContinue"
    );
    const membershipSelectionBasic = document.getElementById("membershipSelectionBasic");
    const membershipSelectionError = document.getElementById("membershipSelectionError");
    const membershipTermsOverlay = document.getElementById("membershipTermsOverlay");
    const membershipTermsClose = document.getElementById("membershipTermsClose");
    const membershipTermsCheckbox = document.getElementById("membershipTermsCheckbox");
    const membershipTermsAccept = document.getElementById("membershipTermsAccept");
    const membershipTermsError = document.getElementById("membershipTermsError");
    const membershipSignatureCanvas = document.getElementById(
      "membershipSignatureCanvas"
    );
    const membershipSignatureClear = document.getElementById("membershipSignatureClear");

    const riderEmailDetailEl = document.getElementById("riderEmailDetail");
    const riderPhoneDetailEl = document.getElementById("riderPhoneDetail");
    const riderAddressDetailEl = document.getElementById("riderAddressDetail");
    const riderMembershipDetailEl = document.getElementById("riderMembershipDetail");
    const editProfileButton = document.getElementById("editProfileButton");
    const editProfileSection = document.getElementById("editProfileSection");
    const editFullNameEl = document.getElementById("editFullName");
    const editPhoneEl = document.getElementById("editPhone");
    const editStreetEl = document.getElementById("editStreet");
    const editCityEl = document.getElementById("editCity");
    const editStateEl = document.getElementById("editState");
    const editZipEl = document.getElementById("editZip");
    const editProfilePicInput = document.getElementById("editProfilePicInput");
    const editLicensePicInput = document.getElementById("editLicensePicInput");
    const editStudentIdPicInput = document.getElementById("editStudentIdPicInput");
    const editGenderEl = document.getElementById("editGender");
    const saveProfileButton = document.getElementById("saveProfileButton");

    const joinBanner = document.getElementById("joinBanner");
    const joinBannerText = document.getElementById("joinBannerText");

    const poolGroupTitle = document.getElementById("poolGroupTitle");
    const poolGroupBox = document.getElementById("poolGroupBox");
    const poolGroupStatus = document.getElementById("poolGroupStatus");
    const poolGroupList = document.getElementById("poolGroupList");

    const profileMessage = document.getElementById("profileMessage");
    const profileError = document.getElementById("profileError");

    const mapEl = document.getElementById("map");
    const destinationEl = document.getElementById("destination");
    const numRidersEl = document.getElementById("numRiders");
    const ridersSection = document.getElementById("ridersSection");
    const tripMapPreviewEl = document.getElementById("tripMapPreview");
    const destinationPreviewMapEl = document.getElementById("destinationPreviewMap");
    const destinationPreviewEmptyEl = document.getElementById("destinationPreviewEmpty");
    const fareNotReady = document.getElementById("fareNotReady");
    const fareReady = document.getElementById("fareReady");
    const fareTime = document.getElementById("fareTime");
    const fareDistance = document.getElementById("fareDistance");
    const fareMembership = document.getElementById("fareMembership");
    const fareTotal = document.getElementById("fareTotal");
    const syncButton = document.getElementById("syncButton");
    const logoutButton = document.getElementById("logoutButton");

    const cancelRideButton = document.getElementById("cancelRideButton");
    const cancelError = document.getElementById("cancelError");

    const groupQrSection = document.getElementById("groupQrSection");
    const groupQrCanvas = document.getElementById("groupQrCanvas");
    const groupOccupancyLabel = document.getElementById("groupOccupancyLabel");
    let groupQr = null;

    try {
      await loadGoogleMapsSdk({ apiKey: mapsApiKey, libraries: mapsLibraries });
    } catch (err) {
      googleMapsLoadFailed = true;
      console.error("Google Maps SDK failed to load", err);
      if (profileError) {
        profileError.textContent =
          "Unable to load maps right now. Please refresh or verify the Maps API key.";
      }
    }

    // Rider active-ride overlay + mini bar + summary
    const riderOverlay = document.getElementById("riderOverlay");
    const riderOverlayTitle = document.getElementById("riderOverlayTitle");
    const riderOverlaySubtitle = document.getElementById("riderOverlaySubtitle");
    const riderOverlayError = document.getElementById("riderOverlayError");
    const riderStateElements = {
      searching: document.getElementById("riderStateSearching"),
      driverEta: document.getElementById("riderStateDriverEta"),
      pickupPin: document.getElementById("riderStatePickupPin"),
      inTrip: document.getElementById("riderStateInTrip"),
      dropoffPin: document.getElementById("riderStateDropoffPin"),
      rateTip: document.getElementById("riderStateRateTip"),
      thanks: document.getElementById("riderStateThanks")
    };
    const driverInfoSlotPickup = riderStateElements.driverEta?.querySelector(".driver-info-slot") || null;
    const driverInfoSlotTrip = riderStateElements.inTrip?.querySelector(".driver-info-slot") || null;
    const riderPickupPinValue = document.getElementById("riderPickupPinValue");
    const riderDropoffPinValue = document.getElementById("riderDropoffPinValue");
    const riderTripEtaText = document.getElementById("riderTripEtaText");
    const driverInfoStack = document.getElementById("driverInfoStack");
    const ratingStarsContainer = document.getElementById("ratingStars");
    const ratingError = document.getElementById("ratingError");
    const tipOptions = document.getElementById("tipOptions");
    const tipCustomInput = document.getElementById("tipCustomInput");
    const submitRatingButton = document.getElementById("submitRatingButton");
    const riderFeedbackInput = document.getElementById("riderFeedbackInput");

    const driverIdentityCardEl = document.getElementById("driverIdentityCard");
    const driverIdentityNameEl = document.getElementById("driverIdentityName");
    const driverIdentityStatusEl = document.getElementById("driverIdentityStatus");
    const driverIdentityRatingEl = document.getElementById("driverIdentityRating");
    const driverIdentityAvatarImg = document.getElementById("driverIdentityAvatarImg");
    const driverIdentityAvatarFallback = document.getElementById("driverIdentityAvatarFallback");
    const driverIdentityPhoneRow = document.getElementById("driverIdentityPhoneRow");
    const driverIdentityPhoneEl = document.getElementById("driverIdentityPhone");
    const driverIdentityBadgesEl = document.getElementById("driverIdentityBadges");
    const driverIdentityEtaEl = document.getElementById("driverIdentityEta");
    const driverMiniMapShell = document.getElementById("driverMiniMapShell");
    const driverMiniMapEl = document.getElementById("driverMiniMap");
    const driverMiniMapStatusEl = document.getElementById("driverMiniMapStatus");

    const driverVehicleSection = document.getElementById("driverVehicleSection");
    const driverVehiclePhotoImg = document.getElementById("driverVehiclePhoto");
    const driverVehicleFallbackEl = document.getElementById("driverVehicleFallback");
    const driverVehicleNameEl = document.getElementById("driverVehicleName");
    const driverVehiclePlateEl = document.getElementById("driverVehiclePlate");
    const driverVehicleNoteEl = document.getElementById("driverVehicleNote");

    const driverLicenseSection = document.getElementById("driverLicenseSection");
    const driverLicensePhotoImg = document.getElementById("driverLicensePhoto");
    const driverLicenseFallbackEl = document.getElementById("driverLicenseFallback");
    const driverLicenseSummaryEl = document.getElementById("driverLicenseSummary");
    const driverLicenseMetaEl = document.getElementById("driverLicenseMeta");

    const supportPanel = document.getElementById("supportPanel");
    const supportBackButton = document.getElementById("supportBackButton");
    const supportCallButton = document.getElementById("supportCallButton");
    const supportTextButton = document.getElementById("supportTextButton");

    const rideSummary = document.getElementById("rideSummary");
    const rideSummaryText = document.getElementById("rideSummaryText");

    const contactDriverBtn = document.getElementById("contactDriverBtn");
    const rideViewTabs = document.querySelectorAll("[data-view-tab]");
    const rideViewPanels = document.querySelectorAll("[data-view-panel]");

    const paymentOverlay = document.getElementById("paymentOverlay");
    const paymentOverlayTitle = document.getElementById("paymentOverlayTitle");
    const paymentOverlaySubtitle = document.getElementById("paymentOverlaySubtitle");
    const paymentOverlayClose = document.getElementById("paymentOverlayClose");
    const paymentOverlayConfirm = document.getElementById("paymentOverlayConfirm");
    const paymentOverlayMessage = document.getElementById("paymentOverlayMessage");
    const paymentElementContainer = document.getElementById("paymentElement");

    let latestRideForOverlay = null;
    let stripeInstance = null;
    let stripeElements = null;
    let stripePaymentElement = null;
    let activePaymentContext = null;
    let stripeJsPromise = null;

    const RIDER_STATES = {
      HIDDEN: "hidden",
      SEARCHING: "searching",
      DRIVER_TO_PICKUP: "driver_to_pickup",
      PICKUP_PIN: "pickup_pin",
      IN_TRIP: "in_trip",
      DROPOFF_PIN: "dropoff_pin",
      RATE_TIP: "rate_tip",
      THANKS: "thanks"
    };

    let riderOverlayState = RIDER_STATES.HIDDEN;
    let selectedRating = 0;
    let selectedTipValue = 0;
    let tipIsCustom = false;
    let ratingSubmitting = false;

    let isSignupMode = false;
    let currentUserProfile = null;
    let pendingMembershipPlanId = null;
    let membershipSignatureCtx = null;
    let membershipSignatureDrawing = false;
    let membershipSignatureHasInk = false;
    let membershipTermsProcessing = false;

    let map;
    let directionsService;
    let directionsRenderer;
    let pickupMarker;
    let destMarker;
    let destinationPreviewMap;
    let destinationPreviewPickupMarker;
    let destinationPreviewDestMarker;
    let driverMiniMap;
    let driverMiniMapDriverMarker;
    let driverMiniMapPickupMarker;
    let driverMiniMapDropoffMarker;
    let lastDriverMiniMapData = null;
    let currentLocation = null;
    let destinationLatLng = null;
    let destAutocomplete = null;
    let lastRideMetrics = null;
    let activeRideViewSection = "destination";

    let activeRideUnsub = null;
    let activeGroupUnsub = null;
    let groupOccupancyUnsub = null;

    let currentRideId = null;
    let currentRideStatus = null;
    let currentRideWatcher = null;

    const riderCancelableStatuses = new Set([
      "pending_driver",
      "pooled_pending_driver",
      "pool_searching",
      "driver_assigned",
      "driver_arrived",
      "pending"
    ]);

    function updateCancelButtonVisibility() {
      if (!cancelRideButton) return;
      const hasRide = !!currentRideId;
      const cancelable =
        !currentRideStatus || riderCancelableStatuses.has(currentRideStatus);
      const shouldShow = hasRide && cancelable;
      cancelRideButton.hidden = !shouldShow;
      if (!shouldShow && cancelError) {
        cancelError.textContent = "";
      }
    }

    function setRideViewPanel(targetKey) {
      if (!targetKey || !rideViewPanels.length) return;
      activeRideViewSection = targetKey;
      rideViewTabs.forEach((tab) => {
        if (!tab?.dataset?.viewTab) return;
        const isActive = tab.dataset.viewTab === targetKey;
        tab.classList.toggle("active", isActive);
        tab.setAttribute("aria-selected", isActive ? "true" : "false");
        tab.setAttribute("tabindex", isActive ? "0" : "-1");
      });
      rideViewPanels.forEach((panel) => {
        if (!panel?.dataset?.viewPanel) return;
        const isActive = panel.dataset.viewPanel === targetKey;
        panel.classList.toggle("active", isActive);
        panel.setAttribute("aria-hidden", isActive ? "false" : "true");
      });
      if (targetKey === "destination") {
        setTimeout(() => {
          if (destinationPreviewMap && window.google?.maps) {
            google.maps.event.trigger(destinationPreviewMap, "resize");
          }
          updateTripPreviewMap();
        }, 80);
      }
    }

    if (rideViewTabs.length && rideViewPanels.length) {
      rideViewTabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          const key = tab.dataset?.viewTab;
          if (key && key !== activeRideViewSection) {
            setRideViewPanel(key);
          }
        });
      });
    }

    updateCancelButtonVisibility();

    function clearCurrentRideState() {
        currentRideId = null;
        currentRideStatus = null;
        if (currentRideWatcher) {
          currentRideWatcher();
          currentRideWatcher = null;
        }
        if (activeRideUnsub) {
          activeRideUnsub();
          activeRideUnsub = null;
        }
        if (activeGroupUnsub) {
          activeGroupUnsub();
          activeGroupUnsub = null;
        }
        hideGroupQr();
        updateCancelButtonVisibility();
      }

      function resetJoinModeUi() {
        joinMode = false;
        joinTargetRide = null;
        if (joinBanner) joinBanner.style.display = "none";
        if (ridersSection) ridersSection.style.display = "block";
        if (numRidersEl) {
          numRidersEl.disabled = false;
        }
        updateSyncButtonLabel();
      }

      function returnToHomeAfterRide(message = "", isError = false) {
        clearCurrentRideState();
        setRiderOverlayState(RIDER_STATES.HIDDEN);
        supportPanel?.classList.remove("active");
        if (rideSummary) rideSummary.style.display = "none";
        showRideView();
        clearPoolGroupUI();
        resetJoinModeUi();
        hideGroupQr();
        resetTripPlanner();
        resetRatingForm();
        if (cancelError) cancelError.textContent = "";

        if (isError) {
          profileError.textContent = message || "";
          profileMessage.textContent = "";
        } else {
          profileMessage.textContent = message || "";
          profileError.textContent = "";
        }
      }

    function safeImageUrl(url) {
      if (!url && url !== 0) return null;
      const value = String(url).trim();
      if (!value || value === "null" || value === "undefined") return null;
      return value;
    }

    function applyImage(imgEl, fallbackEl, url, placeholder) {
      if (!imgEl) return;
      const finalUrl = safeImageUrl(url);
      const hasRealImage = !!finalUrl;
      const source = hasRealImage ? finalUrl : (placeholder || null);
      if (source) {
        imgEl.src = source;
        imgEl.style.display = "block";
        imgEl.onerror = () => {
          imgEl.onerror = null;
          if (placeholder) {
            imgEl.src = placeholder;
          }
        };
        if (fallbackEl) {
          fallbackEl.style.display = hasRealImage ? "none" : "flex";
        }
      } else {
        imgEl.removeAttribute("src");
        imgEl.style.display = "none";
        if (fallbackEl) {
          fallbackEl.style.display = "flex";
        }
      }
    }

    function parseLatLngCandidate(value) {
      if (!value) return null;
      if (typeof value.lat === "number" && typeof value.lng === "number") {
        return { lat: value.lat, lng: value.lng };
      }
      if (typeof value.latitude === "number" && typeof value.longitude === "number") {
        return { lat: value.latitude, lng: value.longitude };
      }
      return null;
    }

    function extractLatLngFromPairs(target, pairs) {
      for (const [latKey, lngKey] of pairs) {
        const lat = target?.[latKey];
        const lng = target?.[lngKey];
        if (typeof lat === "number" && typeof lng === "number") {
          return { lat, lng };
        }
      }
      return null;
    }

    function extractPickupLocationFromRide(data) {
      if (!data) return null;
      const candidates = [
        data.pickupLocation,
        data.fromLocation,
        data.originLocation,
        data.pickupGeo,
        data.pickupCoordinates,
        data.fromCoordinates
      ];
      for (const candidate of candidates) {
        const parsed = parseLatLngCandidate(candidate);
        if (parsed) return parsed;
      }
      return extractLatLngFromPairs(data, [
        ["pickupLat", "pickupLng"],
        ["fromLat", "fromLng"],
        ["originLat", "originLng"]
      ]);
    }

    function extractDropoffLocationFromRide(data) {
      if (!data) return null;
      const candidates = [
        data.dropoffLocation,
        data.toLocation,
        data.destinationLocation,
        data.destLocation,
        data.dropoffGeo,
        data.toCoordinates,
        data.destCoordinates
      ];
      for (const candidate of candidates) {
        const parsed = parseLatLngCandidate(candidate);
        if (parsed) return parsed;
      }
      return extractLatLngFromPairs(data, [
        ["dropoffLat", "dropoffLng"],
        ["destLat", "destLng"],
        ["toLat", "toLng"],
        ["destinationLat", "destinationLng"]
      ]);
    }

    function extractDriverLocation(data) {
      if (!data) return null;
      const candidates = [
        data.driverLocation,
        data.driverCurrentLocation,
        data.currentDriverLocation
      ];
      for (const candidate of candidates) {
        const parsed = parseLatLngCandidate(candidate);
        if (parsed) return parsed;
      }
      return extractLatLngFromPairs(data, [
        ["driverLat", "driverLng"],
        ["driverLatitude", "driverLongitude"],
        ["driverCurrentLat", "driverCurrentLng"]
      ]);
    }

    function formatPhoneDisplay(phone) {
      if (!phone) return "";
      const digits = phone.replace(/\D/g, "");
      if (!digits) return "";
      let clean = digits;
      if (clean.length === 11 && clean.startsWith("1")) {
        clean = clean.slice(1);
      }
      if (clean.length === 10) {
        return `(${clean.slice(0, 3)}) ${clean.slice(3, 6)}-${clean.slice(6)}`;
      }
      return phone;
    }

    function renderDriverBadges(data) {
      if (!driverIdentityBadgesEl) return;
      const badges = [];
      if (data?.driverVerifiedId) badges.push("Verified ID");
      if (data?.driverDrugTestCleared) badges.push("Drug Test Cleared");
      if (data?.driverBackgroundCheckCleared) badges.push("Background Check Cleared");
      if (badges.length) {
        driverIdentityBadgesEl.innerHTML = badges
          .map((label) => `<span class="driver-badge-pill">${label}</span>`)
          .join("");
        driverIdentityBadgesEl.style.display = "flex";
      } else {
        driverIdentityBadgesEl.innerHTML = "";
        driverIdentityBadgesEl.style.display = "none";
      }
    }

    function renderDriverIdentity(data) {
      if (!driverIdentityCardEl) return;
      const name = data?.driverName || "RideSync driver";
      driverIdentityNameEl.textContent = name;

      const avatarUrl =
        safeImageUrl(data?.driverAvatarUrl) ||
        safeImageUrl(data?.driverPhotoUrl) ||
        safeImageUrl(data?.driverProfilePicUrl);
      applyImage(driverIdentityAvatarImg, driverIdentityAvatarFallback, avatarUrl, DRIVER_PLACEHOLDER_AVATAR);
      if (driverIdentityAvatarFallback) {
        const initials = name
          .split(" ")
          .filter(Boolean)
          .map((part) => part[0])
          .join("")
          .slice(0, 2)
          .toUpperCase() || "RS";
        driverIdentityAvatarFallback.textContent = initials;
      }

      const ratingValue = Number(data?.driverRating);
      const hasRating = !Number.isNaN(ratingValue) && ratingValue > 0;
      if (hasRating) {
        driverIdentityRatingEl.textContent = `★ ${ratingValue.toFixed(1)}`;
        driverIdentityRatingEl.style.display = "inline-flex";
        const rideCount = Number(data?.driverRatingCount);
        driverIdentityStatusEl.textContent = rideCount
          ? `${rideCount}+ RideSync trips`
          : "RideSync trusted";
      } else {
        driverIdentityRatingEl.style.display = "none";
        driverIdentityStatusEl.textContent = "New RideSync driver";
      }

      const rawPhone = data?.driverPhone || data?.driverPhoneNumber;
      const formattedPhone = formatPhoneDisplay(rawPhone || "");
      if (formattedPhone) {
        driverIdentityPhoneEl.textContent = `Call or text ${formattedPhone}`;
        driverIdentityPhoneRow?.classList.remove("hidden");
      } else if (data?.driverContactViaRideSync) {
        driverIdentityPhoneEl.textContent = "Contact RideSync support";
        driverIdentityPhoneRow?.classList.remove("hidden");
      } else {
        driverIdentityPhoneEl.textContent = "";
        driverIdentityPhoneRow?.classList.add("hidden");
      }

      if (driverIdentityEtaEl) {
        const statusCopy = friendlyDriverStatus(data);
        const etaCopy = formatDriverEtaText(data);
        const combined = [statusCopy, etaCopy].filter(Boolean).join(" • ");
        if (combined) {
          driverIdentityEtaEl.textContent = combined;
          driverIdentityEtaEl.style.display = "block";
        } else {
          driverIdentityEtaEl.textContent = "";
          driverIdentityEtaEl.style.display = "none";
        }
      }

      renderDriverBadges(data);
    }

    function buildVehicleName(data) {
      if (data?.driverVehicleName) return data.driverVehicleName;
      if (data?.driverVehicleDisplayName) return data.driverVehicleDisplayName;
      const parts = [
        data?.driverVehicleYear,
        data?.driverVehicleColor,
        data?.driverVehicleMake,
        data?.driverVehicleModel
      ].filter(Boolean);
      return parts.join(" ").replace(/\s+/g, " ").trim();
    }

    function renderVehicleSection(data) {
      if (!driverVehicleSection) return;
      const vehicleName = buildVehicleName(data);
      const plate = data?.driverVehiclePlate || data?.driverLicensePlate;
      const photoUrl = data?.driverVehiclePhotoUrl || data?.driverVehiclePhoto;
      const hasAny =
        vehicleName ||
        plate ||
        safeImageUrl(photoUrl);
      if (!hasAny) {
        driverVehicleSection.style.display = "none";
        return;
      }
      driverVehicleSection.style.display = "block";
      applyImage(driverVehiclePhotoImg, driverVehicleFallbackEl, photoUrl, VEHICLE_PLACEHOLDER_IMG);
      driverVehicleNameEl.textContent = vehicleName || "Vehicle verified with RideSync";
      driverVehiclePlateEl.textContent = plate ? `Plate: ${plate}` : "";
      driverVehiclePlateEl.style.display = plate ? "block" : "none";
      driverVehicleNoteEl.textContent = !vehicleName && !plate ? "Vehicle verified with RideSync" : "";
      driverVehicleNoteEl.style.display = driverVehicleNoteEl.textContent ? "block" : "none";
    }

    function renderLicenseSection(data) {
      if (!driverLicenseSection) return;
      const licenseSummary =
        data?.driverLicenseSummary ||
        data?.driverLicenseStatus ||
        (data?.driverLicenseVerified ? "License verified with RideSync" : "");
      const licenseMeta = data?.driverLicenseMeta || (data?.driverLicenseLast4 ? `Ending in ${data.driverLicenseLast4}` : "");
      const photoUrl = data?.driverLicenseImageUrl || data?.driverLicensePhotoUrl;
      const hasAny = licenseSummary || licenseMeta || safeImageUrl(photoUrl);
      if (!hasAny) {
        driverLicenseSection.style.display = "none";
        return;
      }
      driverLicenseSection.style.display = "block";
      applyImage(driverLicensePhotoImg, driverLicenseFallbackEl, photoUrl, LICENSE_PLACEHOLDER_IMG);
      driverLicenseSummaryEl.textContent = licenseSummary || "License verified with RideSync";
      driverLicenseMetaEl.textContent = licenseMeta || "";
      driverLicenseMetaEl.style.display = licenseMeta ? "block" : "none";
    }

    function ensureDriverMiniMap() {
      if (googleMapsLoadFailed) return false;
      if (!driverMiniMapEl) return false;
      if (!window.google || !google.maps) return false;
      if (!driverMiniMap) {
        driverMiniMap = new google.maps.Map(driverMiniMapEl, {
          center: { lat: 36.0626, lng: -94.1574 },
          zoom: 13,
          disableDefaultUI: true,
          gestureHandling: "none",
          clickableIcons: false
        });
        driverMiniMapDriverMarker = new google.maps.Marker({
          map: driverMiniMap,
          visible: false,
          zIndex: 3,
          icon: {
            path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
            scale: 5,
            fillColor: "#f97316",
            fillOpacity: 1,
            strokeColor: "#fed7aa",
            strokeWeight: 1
          }
        });
        driverMiniMapPickupMarker = new google.maps.Marker({
          map: driverMiniMap,
          visible: false,
          zIndex: 2,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 6,
            fillColor: "#22c55e",
            fillOpacity: 1,
            strokeColor: "#022c22",
            strokeWeight: 2
          }
        });
        driverMiniMapDropoffMarker = new google.maps.Marker({
          map: driverMiniMap,
          visible: false,
          zIndex: 1,
          icon: "https://maps.gstatic.com/mapfiles/api-3/images/spotlight-poi2_hdpi.png"
        });
      }
      return true;
    }

    function setDriverMiniMapStatus(message) {
      if (!driverMiniMapShell || !driverMiniMapStatusEl) return;
      if (message) {
        driverMiniMapShell.classList.add("show-status");
        driverMiniMapStatusEl.textContent = message;
      } else {
        driverMiniMapShell.classList.remove("show-status");
        driverMiniMapStatusEl.textContent = "";
      }
    }

    function updateDriverMiniMap(data) {
      if (data) {
        lastDriverMiniMapData = data;
      } else if (lastDriverMiniMapData) {
        data = lastDriverMiniMapData;
      } else {
        return;
      }
      if (!driverMiniMapShell) return;

      const status = (data?.status || "").toLowerCase();
      const shouldShow =
        status === "driver_assigned" ||
        status === "driver_arrived" ||
        status === "pickup_code_verified" ||
        status === "in_progress";

      if (!shouldShow) {
        driverMiniMapShell.style.display = "none";
        setDriverMiniMapStatus("");
        return;
      }

      driverMiniMapShell.style.display = "block";

      if (!ensureDriverMiniMap()) {
        setDriverMiniMapStatus(googleMapsLoadFailed ? "Maps unavailable." : "Loading map…");
        return;
      }

      const driverLoc = extractDriverLocation(data);
      const pickupLoc = extractPickupLocationFromRide(data);
      const dropoffLoc = extractDropoffLocationFromRide(data);

      if (!driverLoc) {
        setDriverMiniMapStatus("Waiting for driver location…");
      } else {
        setDriverMiniMapStatus("");
      }

      if (driverMiniMapDriverMarker) {
        driverMiniMapDriverMarker.setVisible(!!driverLoc);
        if (driverLoc) {
          driverMiniMapDriverMarker.setPosition(driverLoc);
          const heading =
            typeof data?.driverHeading === "number"
              ? data.driverHeading
              : typeof data?.driverHeadingDeg === "number"
              ? data.driverHeadingDeg
              : null;
          if (heading != null && driverMiniMapDriverMarker.getIcon()) {
            const icon = { ...driverMiniMapDriverMarker.getIcon(), rotation: heading };
            driverMiniMapDriverMarker.setIcon(icon);
          }
        }
      }

      if (driverMiniMapPickupMarker) {
        driverMiniMapPickupMarker.setVisible(!!pickupLoc);
        if (pickupLoc) {
          driverMiniMapPickupMarker.setPosition(pickupLoc);
        }
      }

      if (driverMiniMapDropoffMarker) {
        driverMiniMapDropoffMarker.setVisible(!!dropoffLoc);
        if (dropoffLoc) {
          driverMiniMapDropoffMarker.setPosition(dropoffLoc);
        }
      }

      const bounds = new google.maps.LatLngBounds();
      let hasBounds = false;
      [driverLoc, pickupLoc, dropoffLoc].forEach((loc) => {
        if (loc) {
          bounds.extend(loc);
          hasBounds = true;
        }
      });

      if (hasBounds) {
        driverMiniMap.fitBounds(bounds, 30);
      } else {
        driverMiniMap.setCenter({ lat: 36.0626, lng: -94.1574 });
        driverMiniMap.setZoom(12);
      }
    }

    function refreshDriverMiniMap() {
      if (!driverMiniMap || !driverMiniMapShell || driverMiniMapShell.style.display === "none") {
        return;
      }
      google.maps.event.trigger(driverMiniMap, "resize");
      updateDriverMiniMap();
    }

    function friendlyDriverStatus(data) {
      if (!data?.status) return "";
      if (data.status === "driver_arrived") return "Driver has arrived";
      if (data.status === "driver_assigned") return "Driver en route to pickup";
      if (data.status === "in_progress") return "Ride in progress";
      if (data.status === "completed") return "Ride completed";
      return data.status.replaceAll("_", " ");
    }

    function formatDriverEtaText(data) {
      if (!data) return "";
      if (typeof data.driverEtaMinutes === "number") {
        const eta = Math.max(0, data.driverEtaMinutes);
        return eta < 1 ? "Less than a minute away" : `Approx. ${Math.round(eta)} min away`;
      }
      if (typeof data.remainingEtaMinutes === "number") {
        const remaining = Math.max(0, data.remainingEtaMinutes);
        return remaining < 1 ? "Almost there" : `About ${Math.round(remaining)} min remaining`;
      }
      return formatTripEstimate(data) || "";
    }

    function showAuthView() {
      authView.classList.add("active");
      rideView.classList.remove("active");
      loadingView.classList.remove("active");
    }
    function showRideView() {
      authView.classList.remove("active");
      rideView.classList.add("active");
      loadingView.classList.remove("active");
    }
    function showLoadingView() {
      authView.classList.remove("active");
      rideView.classList.remove("active");
      loadingView.classList.add("active");
    }

    function setMembershipBadge(profile) {
      const plan = normalizePlanKey(profile?.membershipType || profile?.membership);
      const isStudent = !!profile?.isStudent;
      const uofaVerified = !!profile?.uofaVerified;

      membershipBadgeEl.className = "badge";
      membershipBadgeLabelEl.textContent = "";
      membershipBadgeTagEl.textContent = "";

      if (plan === "uofa_unlimited") {
        membershipBadgeEl.classList.add("badge-uofa");
        membershipBadgeLabelEl.textContent = "U of A Unlimited";
        membershipBadgeTagEl.textContent = uofaVerified
          ? "Verified student"
          : profile?.membershipStatus === "pending_verification"
          ? "Pending approval"
          : (isStudent ? "Student (pending ID)" : "");
      } else if (plan === "nwa_unlimited") {
        membershipBadgeEl.classList.add("badge-nwa");
        membershipBadgeLabelEl.textContent = "NWA Unlimited";
        membershipBadgeTagEl.textContent = "30-mi NWA zone";
      } else {
        membershipBadgeEl.classList.add("badge-basic");
        membershipBadgeLabelEl.textContent = "Basic";
        membershipBadgeTagEl.textContent = "Pay per ride";
      }
    }

    function formatCurrencyFromCents(amountCents = 0, currency = "usd") {
      const value = Number(amountCents || 0) / 100;
      try {
        return new Intl.NumberFormat("en-US", {
          style: "currency",
          currency: (currency || "usd").toUpperCase(),
        }).format(value);
      } catch (err) {
        return `$${value.toFixed(2)}`;
      }
    }

    function formatPlanPriceLabel(planKey) {
      const key = normalizePlanKey(planKey);
      return (
        stripeMembershipConfig?.[key]?.priceDisplay ||
        MEMBERSHIP_PLAN_COPY[key]?.price ||
        MEMBERSHIP_PLAN_COPY.basic.price
      );
    }

    function updateMembershipPrices() {
      if (!membershipPriceEls || typeof membershipPriceEls.forEach !== "function") {
        return;
      }
      membershipPriceEls.forEach((node) => {
        const planKey = node?.dataset?.planPrice;
        if (!planKey) return;
        node.textContent = formatPlanPriceLabel(planKey);
      });
    }

    updateMembershipPrices();

    function normalizePlanKey(plan) {
      const raw = (plan ?? "").toString().trim().toLowerCase();
      if (!raw) {
        return "basic";
      }
      for (const [planKey, aliases] of Object.entries(MEMBERSHIP_PLAN_KEY_ALIASES)) {
        if (aliases.has(raw) || raw === planKey) {
          return planKey;
        }
      }
      return raw;
    }

    function formatMembershipPlanLabel(planKey) {
      const normalized = normalizePlanKey(planKey);
      return (
        MEMBERSHIP_PLAN_COPY[normalized]?.label ||
        MEMBERSHIP_PLAN_COPY.basic.label
      );
    }

    function formatMembershipStatusLabel(status) {
      const normalized = (status || "active").toString().toLowerCase();
      if (normalized === "pending_verification") return "Pending approval";
      if (normalized === "none") return "Not active";
      if (normalized === "inactive") return "Inactive";
      if (normalized === "canceled") return "Canceled";
      return "Active";
    }

    // === RIDE SYNC STRIPE: START membership summary helper ===
    function formatMembershipSummary(planKey, status) {
      const plan = normalizePlanKey(planKey);
      const normalizedStatus = (status || "none").toLowerCase();
      if (plan === "uofa_unlimited") {
        if (normalizedStatus === "pending_verification") {
          return "U of A Unlimited (Pending verification)";
        }
        if (normalizedStatus === "active") {
          return "U of A Unlimited (Active)";
        }
        return "U of A Unlimited";
      }
      if (plan === "nwa_unlimited") {
        if (normalizedStatus === "pending_verification") {
          return "NWA Unlimited (Pending verification)";
        }
        if (normalizedStatus === "active") {
          return "NWA Unlimited (Active)";
        }
        return "NWA Unlimited";
      }
      return "Basic (pay per ride)";
    }
    function isUnlimitedMembershipActive(planKey, status) {
      const plan = normalizePlanKey(planKey);
      const normalizedStatus = (status || "none").toLowerCase();
      if (normalizedStatus !== "active") return false;
      return plan === "uofa_unlimited" || plan === "nwa_unlimited";
    }
    // === RIDE SYNC STRIPE: END membership summary helper ===

    function planRequiresApproval(planKey) {
      return normalizePlanKey(planKey) === "uofa_unlimited";
    }

    function renderMembershipCard(profile) {
      if (!membershipCard) return;
      const plan = normalizePlanKey(profile?.membershipType || profile?.membership || "basic");
      const planCopy = MEMBERSHIP_PLAN_COPY[plan] || MEMBERSHIP_PLAN_COPY.basic;
      const statusLabel = formatMembershipStatusLabel(profile?.membershipStatus);
      const summaryLabel = formatMembershipSummary(plan, profile?.membershipStatus);

      if (membershipStatusText) {
        membershipStatusText.textContent = `Plan: ${planCopy.label}`;
      }
      if (membershipCurrentLabel) {
        membershipCurrentLabel.textContent = summaryLabel;
      }

      if (membershipStatusBadge) {
        const normalizedStatus = (profile?.membershipStatus || "none").toLowerCase();
        const isActive = normalizedStatus === "active";
        const isPending = normalizedStatus === "pending_verification";
        membershipStatusBadge.textContent = statusLabel;
        membershipStatusBadge.classList.toggle("active", isActive);
        membershipStatusBadge.classList.toggle("pending", isPending);
        membershipStatusBadge.classList.toggle(
          "inactive",
          !isActive && !isPending
        );
      }
    }

    async function applyMembershipPlanLocally(plan) {
      const user = auth.currentUser;
      if (!user) return;
      const normalizedPlan = normalizePlanKey(plan || "basic");
      const needsApproval = planRequiresApproval(normalizedPlan);
      const isBasicPlan = normalizedPlan === "basic";
      const updates = {
        membershipType: normalizedPlan,
        membershipStatus: isBasicPlan
          ? "none"
          : needsApproval
          ? "pending_verification"
          : "active",
        membershipRenewedAt: serverTimestamp(),
        membershipUpdatedAt: serverTimestamp()
      };
      if (!isBasicPlan && !needsApproval) {
        updates.membershipApprovedAt = serverTimestamp();
      }
      await setDoc(doc(db, "users", user.uid), updates, { merge: true });
      await loadUserProfile(user.uid, user.email);
      if (membershipCardMessage) {
        membershipCardMessage.textContent = needsApproval
          ? "U of A membership requested. We'll verify your student ID shortly."
          : `${formatMembershipPlanLabel(normalizedPlan)} activated.`;
      }
    }

    async function callApplyMembershipPlan(payload = {}) {
      if (!APPLY_MEMBERSHIP_PLAN_URL) {
        throw new Error("Membership endpoint is not configured.");
      }
      const user = auth.currentUser;
      if (!user) {
        throw new Error("Log in to manage your membership.");
      }
      const idToken = await user.getIdToken();
      let response;
      try {
        response = await fetch(APPLY_MEMBERSHIP_PLAN_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${idToken}`,
          },
          body: JSON.stringify(payload || {}),
        });
      } catch (networkErr) {
        console.error("callApplyMembershipPlan network", networkErr);
        throw new Error("Unable to reach membership services. Try again.");
      }

      let body = null;
      try {
        body = await response.json();
      } catch (parseErr) {
        body = null;
      }

      if (!response.ok) {
        const message =
          body?.error?.message ||
          body?.message ||
          "Unable to update membership right now.";
        throw new Error(message);
      }

      return body || { status: "updated" };
    }

    function updateSyncButtonLabel() {
      if (joinMode) {
        syncButton.textContent = "Join Ride";
        return;
      }
      const plan = normalizePlanKey(
        currentUserProfile?.membershipType || currentUserProfile?.membership || "basic"
      );
      const membershipStatus = currentUserProfile?.membershipStatus || "none";
      const inHomeZone = !!(lastRideMetrics?.inHomeZone);
      const unlimitedActive = isUnlimitedMembershipActive(plan, membershipStatus);
      if (!unlimitedActive) {
        syncButton.textContent = "Sync & Pay";
      } else if (plan === "uofa_unlimited" || plan === "nwa_unlimited") {
        syncButton.textContent = inHomeZone ? "Sync & Ride" : "Sync & Pay";
      } else {
        syncButton.textContent = "Sync & Pay";
      }
    }

    toggleLink.addEventListener("click", () => {
      isSignupMode = !isSignupMode;
      if (isSignupMode) {
        signupFields.style.display = "block";
        authButton.textContent = "Create account";
        toggleLink.textContent = "Already have an account? Log in";
      } else {
        signupFields.style.display = "none";
        authButton.textContent = "Log in";
        toggleLink.textContent = "New here? Create account";
      }
      authError.textContent = "";
    });
      authButton.addEventListener("click", async () => {
        authError.textContent = "";
        const email = emailEl.value.trim();
        const password = passwordEl.value.trim();
        if (!email || !password) {
          authError.textContent = "Email and password required.";
          return;
        }

        try {
          if (isSignupMode) {
            const cred = await createUserWithEmailAndPassword(auth, email, password);
            await saveUserProfile(cred.user.uid, email);
          } else {
            await signInWithEmailAndPassword(auth, email, password);
          }
        } catch (err) {
          console.error(err);
          authError.textContent = err.message || "Authentication error.";
        }
      });

    logoutButton.addEventListener("click", async () => {
      await signOut(auth);
      currentRideId = null;
      currentRideStatus = null;
      joinMode = false;
      joinTargetRide = null;
      if (currentRideWatcher) {
        currentRideWatcher();
        currentRideWatcher = null;
      }
      if (groupOccupancyUnsub) {
        groupOccupancyUnsub();
        groupOccupancyUnsub = null;
      }
      hideGroupQr();
      clearPoolGroupUI();
      resetTripPlanner();
      joinBanner.style.display = "none";
      ridersSection.style.display = "block";
      showAuthView();
      updateCancelButtonVisibility();
    });

    if (destinationEl) {
      destinationEl.addEventListener("input", () => {
        const currentValue = destinationEl.value.trim();
        const lastValue = (lastDestinationPlace?.formatted_address || "").trim();
        if (!currentValue || currentValue !== lastValue) {
          clearDestinationSelection();
        }
      });
    }

    async function uploadFileIfAny(fileInput, path) {
      const file = fileInput.files[0];
      if (!file) return null;
      const storageRef = ref(storage, path);
      await uploadBytes(storageRef, file);
      return await getDownloadURL(storageRef);
    }

    async function tryUploadFileWithGrace(fileInput, path, label) {
      if (!fileInput || !fileInput.files || !fileInput.files.length) {
        return { url: null, error: null, label };
      }
      try {
        const url = await uploadFileIfAny(fileInput, path);
        return { url, error: null, label };
      } catch (err) {
        console.warn(`Upload failed for ${label}`, err);
        return { url: null, error: err, label };
      }
    }

    async function saveUserProfile(uid, email) {
      const fullName = fullNameEl.value.trim();
      const gender = (genderEl.value || "").trim().toLowerCase();
      const phone = phoneEl.value.trim();
      const street = streetEl.value.trim();
      const city = cityEl.value.trim();
      const state = stateEl.value.trim();
      const zip = zipEl.value.trim();
      const isStudent = isStudentEl.value === "true";
      const membershipType = normalizePlanKey(membershipEl.value || "basic");

      let profilePicUrl = null;
      let licensePicUrl = null;
      let studentIdPicUrl = null;

      try {
        profilePicUrl = await uploadFileIfAny(profilePicInput, `users/${uid}/profile.jpg`);
        licensePicUrl = await uploadFileIfAny(licensePicInput, `users/${uid}/license.jpg`);
        studentIdPicUrl = await uploadFileIfAny(studentIdPicInput, `users/${uid}/studentId.jpg`);
      } catch (err) {
        console.warn("Upload error", err);
      }

      const uofaVerified = !!studentIdPicUrl && isStudent;

      await setDoc(doc(db, "users", uid), {
        email,
        fullName,
        gender,
        phone,
        street,
        city,
        state,
        zip,
        isStudent,
        membershipType,
        membershipStatus: membershipType === "basic" ? "none" : "active",
        profilePicUrl,
        licensePicUrl,
        studentIdPicUrl,
        uofaVerified,
        lastSeenAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
        createdAt: serverTimestamp()
      }, { merge: true });
    }

    async function loadUserProfile(uid, email) {
      const refDoc = doc(db, "users", uid);
      const snap = await getDoc(refDoc);
      if (snap.exists()) {
        currentUserProfile = { uid, email, ...snap.data() };
      } else {
        currentUserProfile = {
          uid,
          email,
          membershipType: "basic",
          membershipStatus: "none"
        };
        await setDoc(refDoc, currentUserProfile, { merge: true });
      }

      await setDoc(refDoc, { lastSeenAt: serverTimestamp() }, { merge: true });

      renderProfile();
    }

    function renderProfile() {
      if (!currentUserProfile) return;
      const p = currentUserProfile;

      const name =
        p.fullName ||
        p.name ||
        p.displayName ||
        (p.email ? p.email.split("@")[0] : "Rider");
      const phone = p.phone || p.phoneNumber || "";

      riderNameEl.textContent = name;
      if (riderEmailDetailEl) {
        riderEmailDetailEl.textContent = p.email || "Not set";
      }

      riderPhoneDetailEl.textContent = phone || "Not set";
      const addressParts = [
        p.street || "",
        [p.city, p.state].filter(Boolean).join(", "),
        p.zip || ""
      ].filter(Boolean);
      riderAddressDetailEl.textContent = addressParts.join(" • ") || "Not set";

      const planKey = normalizePlanKey(p.membershipType || p.membership || "basic");
      const membershipSummary = formatMembershipSummary(planKey, p.membershipStatus);
      riderMembershipDetailEl.textContent = membershipSummary;

      editFullNameEl.value = p.fullName || "";
      editPhoneEl.value = phone || "";
      editStreetEl.value = p.street || "";
      editCityEl.value = p.city || "";
      editStateEl.value = p.state || "";
      editZipEl.value = p.zip || "";
      if (editGenderEl) {
        const g = (p.gender || "").toLowerCase();
        if (g === "male" || g === "female" || g === "other") {
          editGenderEl.value = g;
        } else {
          editGenderEl.value = "";
        }
      }

      const photoUrl = p.profilePicUrl || p.photoURL || null;
      if (photoUrl) {
        avatarEl.style.backgroundImage = `url(${photoUrl})`;
        avatarEl.style.backgroundSize = "cover";
        avatarEl.style.backgroundPosition = "center";
        avatarEl.textContent = "";
      } else {
        avatarEl.style.backgroundImage = "";
        const initials = (name || "RS")
          .split(" ")
          .map((s) => s[0])
          .join("")
          .slice(0, 2)
          .toUpperCase();
        avatarEl.textContent = initials || "RS";
      }

      setMembershipBadge(p);
      renderMembershipCard(p);
      updateSyncButtonLabel();
    }

    editProfileButton.addEventListener("click", () => {
      if (!currentUserProfile) return;
      const isHidden =
        editProfileSection.style.display === "none" ||
        !editProfileSection.style.display;
      editProfileSection.style.display = isHidden ? "block" : "none";
    });

    saveProfileButton.addEventListener("click", async () => {
      profileError.textContent = "";
      profileMessage.textContent = "";
      const user = auth.currentUser;
      if (!user) return;

      const updates = {
        fullName: editFullNameEl.value.trim(),
        phone: editPhoneEl.value.trim(),
        street: editStreetEl.value.trim(),
        city: editCityEl.value.trim(),
        state: editStateEl.value.trim(),
        zip: editZipEl.value.trim(),
        gender: (editGenderEl.value || "").trim().toLowerCase(),
        updatedAt: serverTimestamp()
      };
      const userDocRef = doc(db, "users", user.uid);
      const uploadDescriptors = [
        {
          input: editProfilePicInput,
          path: `users/${user.uid}/profile.jpg`,
          key: "profilePicUrl",
          label: "profile photo"
        },
        {
          input: editLicensePicInput,
          path: `users/${user.uid}/license.jpg`,
          key: "licensePicUrl",
          label: "driver license"
        },
        {
          input: editStudentIdPicInput,
          path: `users/${user.uid}/studentId.jpg`,
          key: "studentIdPicUrl",
          label: "student ID"
        }
      ];

      const uploadResults = [];
      for (const descriptor of uploadDescriptors) {
        const result = await tryUploadFileWithGrace(
          descriptor.input,
          descriptor.path,
          descriptor.label
        );
        uploadResults.push({ ...result, key: descriptor.key });
        if (result.url) {
          updates[descriptor.key] = result.url;
        }
      }

      const isStudent = !!currentUserProfile?.isStudent;
      if (updates.studentIdPicUrl && isStudent) {
        updates.uofaVerified = true;
      }

      try {
        await setDoc(userDocRef, updates, { merge: true });
        await loadUserProfile(user.uid, user.email);
        editProfileSection.style.display = "none";

        editProfilePicInput.value = "";
        editLicensePicInput.value = "";
        editStudentIdPicInput.value = "";

        const failedUploads = uploadResults
          .filter((item) => item.error)
          .map((item) => item.label);
        if (failedUploads.length) {
          profileMessage.textContent = "Profile updated, but some files could not upload.";
          profileError.textContent = `Skipped: ${failedUploads.join(", ")}`;
        } else {
          profileMessage.textContent = "Profile updated.";
          profileError.textContent = "";
        }
      } catch (err) {
        console.error(err);
        profileError.textContent = "Could not update profile.";
      }
    });

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        currentUserProfile = null;
        loginStatusEl.textContent = "";
        showAuthView();
        return;
      }
      loginStatusEl.textContent = "Logged in";
      await loadUserProfile(user.uid, user.email);
      showRideView();
      initMapOnce();

      if (joinRideIdFromUrl && !joinMode) {
        await enterJoinMode(joinRideIdFromUrl);
      }
    });

    function haversineDistanceMiles(lat1, lon1, lat2, lon2) {
      const R = 3958.8;
      const toRad = (v) => (v * Math.PI) / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) *
          Math.cos(toRad(lat2)) *
          Math.sin(dLon / 2) *
          Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function initMapOnce() {
      if (googleMapsLoadFailed) return;
      if (!window.google || !google.maps) return;
      if (map) return;
      map = new google.maps.Map(mapEl, {
        center: { lat: 36.06, lng: -94.16 },
        zoom: 12,
        disableDefaultUI: true
      });
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({
        map,
        suppressMarkers: true,
        preserveViewport: false
      });

      pickupMarker = new google.maps.Marker({
        map,
        title: "Pickup",
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 7,
          fillColor: "#22c55e",
          fillOpacity: 1,
          strokeColor: "#022c22",
          strokeWeight: 2
        }
      });

      destMarker = new google.maps.Marker({
        map,
        title: "Destination",
        icon: "https://maps.gstatic.com/mapfiles/api-3/images/spotlight-poi2_hdpi.png"
      });

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            currentLocation = {
              lat: pos.coords.latitude,
              lng: pos.coords.longitude
            };
            pickupMarker.setPosition(currentLocation);
            map.setCenter(currentLocation);
            if (destinationLatLng) {
              updateTripPreviewMap();
              updateRouteAndFare();
            }
          },
          (err) => {
            console.warn("Geolocation error", err);
          }
        );
      }

      setupDestinationAutocomplete();
    }

    function setupDestinationAutocomplete() {
      if (googleMapsLoadFailed) return;
      if (!window.google || !google.maps || !google.maps.places) return;
      if (!destAutocomplete && window.google && google.maps.places) {
        destAutocomplete = new google.maps.places.Autocomplete(destinationEl, {
          types: ["geocode"],
          componentRestrictions: { country: "us" }
        });

        destAutocomplete.addListener("place_changed", () => {
          const place = destAutocomplete.getPlace();
          if (!place || !place.geometry || !place.geometry.location) return;

          lastDestinationPlace = place;
          lastDestinationIsFayetteville = isFayettevilleFromPlace(place);

          destinationLatLng = place.geometry.location;

          destMarker.setPosition(destinationLatLng);
          destMarker.setVisible(true);

          updateTripPreviewMap();
          updateRouteAndFare();
        });
      }
    }

    function latLngToLiteral(value) {
      if (!value) return null;
      if (typeof value.lat === "function" && typeof value.lng === "function") {
        return { lat: value.lat(), lng: value.lng() };
      }
      if (typeof value.lat === "number" && typeof value.lng === "number") {
        return value;
      }
      return null;
    }

    function ensureDestinationPreviewMap() {
      if (googleMapsLoadFailed) return;
      if (!destinationPreviewMapEl || destinationPreviewMap) return;
      if (!window.google || !google.maps) return;
      destinationPreviewMap = new google.maps.Map(destinationPreviewMapEl, {
        center: { lat: 36.06, lng: -94.16 },
        zoom: 13,
        disableDefaultUI: true,
        draggable: false,
        keyboardShortcuts: false,
        gestureHandling: "none",
        mapTypeControl: false,
        clickableIcons: false,
        styles: [
          { featureType: "poi", stylers: [{ visibility: "off" }] },
          { featureType: "transit", stylers: [{ visibility: "off" }] }
        ]
      });

      destinationPreviewPickupMarker = new google.maps.Marker({
        map: destinationPreviewMap,
        title: "Pickup",
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 6,
          fillColor: "#22c55e",
          fillOpacity: 1,
          strokeColor: "#022c22",
          strokeWeight: 2
        },
        visible: false
      });

      destinationPreviewDestMarker = new google.maps.Marker({
        map: destinationPreviewMap,
        title: "Destination",
        icon: "https://maps.gstatic.com/mapfiles/api-3/images/spotlight-poi2_hdpi.png",
        visible: false
      });
    }

    function hideTripPreviewMap() {
      if (tripMapPreviewEl) {
        tripMapPreviewEl.classList.remove("has-destination");
        tripMapPreviewEl.setAttribute("aria-hidden", "true");
      }
      if (destinationPreviewPickupMarker) {
        destinationPreviewPickupMarker.setVisible(false);
      }
      if (destinationPreviewDestMarker) {
        destinationPreviewDestMarker.setVisible(false);
      }
      if (destinationPreviewEmptyEl) {
        destinationPreviewEmptyEl.style.opacity = "";
      }
    }

    function updateTripPreviewMap() {
      if (!tripMapPreviewEl || !destinationLatLng) {
        hideTripPreviewMap();
        return;
      }
      if (googleMapsLoadFailed) return;
      if (!window.google || !google.maps) {
        setTimeout(updateTripPreviewMap, 700);
        return;
      }
      ensureDestinationPreviewMap();
      if (!destinationPreviewMap) return;

      const destLiteral = latLngToLiteral(destinationLatLng);
      if (!destLiteral) return;

      destinationPreviewDestMarker.setPosition(destLiteral);
      destinationPreviewDestMarker.setVisible(true);

      const bounds = new google.maps.LatLngBounds();
      bounds.extend(destLiteral);

      if (currentLocation && typeof currentLocation.lat === "number" && typeof currentLocation.lng === "number") {
        destinationPreviewPickupMarker.setPosition(currentLocation);
        destinationPreviewPickupMarker.setVisible(true);
        bounds.extend(currentLocation);
      } else if (destinationPreviewPickupMarker) {
        destinationPreviewPickupMarker.setVisible(false);
      }

      if (destinationPreviewPickupMarker?.getVisible()) {
        destinationPreviewMap.fitBounds(bounds);
      } else {
        destinationPreviewMap.setCenter(destLiteral);
        destinationPreviewMap.setZoom(14);
      }

      tripMapPreviewEl.classList.add("has-destination");
      tripMapPreviewEl.setAttribute("aria-hidden", "false");
    }

    async function updateRouteAndFare() {
      if (googleMapsLoadFailed) return;
      if (!window.google || !google.maps) return;
      profileError.textContent = "";
      if (!currentLocation || !destinationLatLng || !directionsService) {
        return;
      }

      const request = {
        origin: currentLocation,
        destination: destinationLatLng,
        travelMode: google.maps.TravelMode.DRIVING
      };

      directionsService.route(request, (result, status) => {
        if (status !== "OK") {
          console.warn("Directions failed", status);
          return;
        }
        directionsRenderer.setDirections(result);

        const leg = result.routes[0].legs[0];
        const totalDurationSec = leg.duration.value;
        const totalDistanceMeters = leg.distance.value;

        const minutes = totalDurationSec / 60;
        const plan = normalizePlanKey(
          currentUserProfile?.membershipType || currentUserProfile?.membership || "basic"
        );

        let inHomeZone = false;

        if (plan === "uofa_unlimited") {
          inHomeZone = lastDestinationIsFayetteville === true;
        } else if (plan === "nwa_unlimited") {
          if (currentLocation && destinationLatLng) {
            const distFromCenterPickup = haversineDistanceMiles(
              NWA_CENTER.lat, NWA_CENTER.lng,
              currentLocation.lat, currentLocation.lng
            );
            const destLat = destinationLatLng.lat();
            const destLng = destinationLatLng.lng();
            const distFromCenterDest = haversineDistanceMiles(
              NWA_CENTER.lat, NWA_CENTER.lng,
              destLat, destLng
            );
            inHomeZone =
              distFromCenterPickup <= NWA_RADIUS_MILES &&
              distFromCenterDest <= NWA_RADIUS_MILES;
          }
        }

        const fareInfo = computeFareForMembership(plan, minutes, inHomeZone);

        lastRideMetrics = {
          durationMinutes: minutes,
          distanceMeters: totalDistanceMeters,
          inHomeZone,
          fareBreakdown: fareInfo,
          membershipLabel: fareInfo.membershipLabel
        };

        fareNotReady.style.display = "none";
        fareReady.style.display = "block";
        fareTime.textContent = `${minutes.toFixed(1)} min`;
        fareDistance.textContent = `${(totalDistanceMeters / 1609.34).toFixed(2)} mi`;
        fareMembership.textContent = fareInfo.membershipLabel;
        fareTotal.textContent = `$${fareInfo.total.toFixed(2)}`;

        updateSyncButtonLabel();
        updateTripPreviewMap();
      });
    }

    function clearDestinationSelection(options = {}) {
      const { resetInput = false } = options;
      lastDestinationPlace = null;
      lastDestinationIsFayetteville = false;
      destinationLatLng = null;
      lastRideMetrics = null;
      hideTripPreviewMap();
      if (resetInput && destinationEl) {
        destinationEl.value = "";
      }
      if (fareReady) {
        fareReady.style.display = "none";
      }
      if (fareNotReady) {
        fareNotReady.style.display = "block";
      }
      fareTime.textContent = "";
      fareDistance.textContent = "";
      fareMembership.textContent = "";
      fareTotal.textContent = "";
      if (destMarker) {
        destMarker.setVisible(false);
      }
      if (directionsRenderer) {
        directionsRenderer.set("directions", null);
      }
    }

    function resetTripPlanner() {
      clearDestinationSelection({ resetInput: true });
      if (numRidersEl) {
        numRidersEl.value = "1";
        numRidersEl.disabled = false;
      }
    }

    function clearPoolGroupUI() {
      poolGroupTitle.style.display = "none";
      poolGroupBox.style.display = "none";
      poolGroupStatus.textContent = "";
      poolGroupList.innerHTML = "";
    }

    function renderPoolGroup(riders) {
      if (!riders || riders.length === 0) {
        poolGroupTitle.style.display = "block";
        poolGroupBox.style.display = "block";
        poolGroupStatus.textContent = "Searching for other U of A riders…";
        poolGroupList.innerHTML = "";
        return;
      }

      poolGroupTitle.style.display = "block";
      poolGroupBox.style.display = "block";
      poolGroupStatus.textContent = `You are pooled with ${riders.length} other U of A rider${riders.length > 1 ? "s" : ""}.`;

      poolGroupList.innerHTML = riders
        .map((r) => {
          const name = r.riderName || "U of A rider";
          const phone = r.riderPhone || "";
          const membership =
            r.membershipType === "uofa_unlimited"
              ? "U of A Unlimited"
              : r.membershipType === "nwa_unlimited"
              ? "NWA Unlimited"
              : "Basic";
          const initials = (name || "RS")
            .split(" ")
            .map((s) => s[0])
            .join("")
            .slice(0, 2)
            .toUpperCase();

          return `
            <div class="fare-row" style="align-items:center; gap:8px;">
              <div style="display:flex; align-items:center; gap:8px;">
                <div style="
                  width:28px;
                  height:28px;
                  border-radius:999px;
                  border:1px solid rgba(148,163,184,0.7);
                  background:#020617;
                  display:flex;
                  align-items:center;
                  justify-content:center;
                  font-size:0.7rem;
                  color:#9ca3af;
                ">
                  ${initials}
                </div>
                <div>
                  <div class="fare-label" style="margin-bottom:1px;">${name}</div>
                  <div class="fare-value" style="font-size:0.7rem;">
                    ${membership}${phone ? " • " + phone : ""}
                  </div>
                </div>
              </div>
            </div>
          `;
        })
        .join("");
    }

    function startPoolGroupWatcher(rideId) {
      clearPoolGroupUI();

      if (activeRideUnsub) {
        activeRideUnsub();
        activeRideUnsub = null;
      }
      if (activeGroupUnsub) {
        activeGroupUnsub();
        activeGroupUnsub = null;
      }

      const rideRef = doc(db, "rideRequests", rideId);
      activeRideUnsub = onSnapshot(rideRef, (snap) => {
        if (!snap.exists()) return;
        const data = snap.data();
        if (data.groupId) {
          subscribeToPoolGroup(data.groupId, rideId);
        }
      });
    }

    function subscribeToPoolGroup(groupId, myRideId) {
      if (activeGroupUnsub) {
        activeGroupUnsub();
        activeGroupUnsub = null;
      }

      const qRef = query(
        collection(db, "rideRequests"),
        where("groupId", "==", groupId)
      );

      const searchStartedAt = Date.now();
      const maxSearchMs = 5000;

      const myGender = normalizePoolGender(currentUserProfile?.gender);

      activeGroupUnsub = onSnapshot(qRef, (qsnap) => {
        const now = Date.now();
        const otherRiders = [];

        qsnap.forEach((docSnap) => {
          if (docSnap.id === myRideId) return;
          const data = docSnap.data();
          const otherGender = normalizePoolGender(data.gender);
          if (!myGender || !otherGender || otherGender !== myGender) {
            return;
          }
          otherRiders.push(data);
        });

        renderPoolGroup(otherRiders);

        if (now - searchStartedAt >= maxSearchMs) {
          if (activeGroupUnsub) {
            activeGroupUnsub();
            activeGroupUnsub = null;
          }
        }
      });
    }

    function computeFareForMembership(plan, minutes, inHomeZone) {
      const {
        BASIC_RATE_PER_MIN,
        BASIC_PLATFORM_FEE,
        BASIC_PROCESSING_FEE_RATE,
        UNLIMITED_OUT_RATE,
        UNLIMITED_PROCESSING_FEE_RATE
      } = FARE_SETTINGS;
      const normalizedPlan = normalizePlanKey(plan);
      const minutesValue = Number(minutes);
      const safeMinutes = Number.isFinite(minutesValue) ? Math.max(0, minutesValue) : 0;

      let membershipLabel = "";
      let rideSubtotal = 0;
      let processingFee = 0;
      let total = 0;

      if (normalizedPlan === "basic") {
        rideSubtotal = safeMinutes * BASIC_RATE_PER_MIN + BASIC_PLATFORM_FEE;
        processingFee = rideSubtotal * BASIC_PROCESSING_FEE_RATE;
        total = rideSubtotal + processingFee;
        membershipLabel = "Basic (pay per ride)";
      } else if (normalizedPlan === "uofa_unlimited") {
        if (inHomeZone) {
          rideSubtotal = 0;
          processingFee = 0;
          total = 0;
          membershipLabel = "U of A Unlimited – in Fayetteville (included)";
        } else {
          rideSubtotal = safeMinutes * UNLIMITED_OUT_RATE;
          processingFee = rideSubtotal * UNLIMITED_PROCESSING_FEE_RATE;
          total = rideSubtotal + processingFee;
          membershipLabel = "U of A Unlimited – out of Fayetteville (extra per-minute)";
        }
      } else if (normalizedPlan === "nwa_unlimited") {
        if (inHomeZone) {
          rideSubtotal = 0;
          processingFee = 0;
          total = 0;
          membershipLabel = "NWA Unlimited – in zone (included)";
        } else {
          rideSubtotal = safeMinutes * UNLIMITED_OUT_RATE;
          processingFee = rideSubtotal * UNLIMITED_PROCESSING_FEE_RATE;
          total = rideSubtotal + processingFee;
          membershipLabel = "NWA Unlimited – out of zone (extra per-minute)";
        }
      } else {
        rideSubtotal = safeMinutes * BASIC_RATE_PER_MIN + BASIC_PLATFORM_FEE;
        processingFee = rideSubtotal * BASIC_PROCESSING_FEE_RATE;
        total = rideSubtotal + processingFee;
        membershipLabel = "Basic (default)";
      }

      return {
        rideSubtotal,
        processingFee,
        total,
        membershipLabel
      };
    }

    async function checkCooldown(userId, plan) {
      const normalizedPlan = normalizePlanKey(plan);
      if (normalizedPlan !== "uofa_unlimited" && normalizedPlan !== "nwa_unlimited") {
        return { allowed: true };
      }

      const coolMinutes = SURGE_MODE ? SURGE_COOLDOWN_MINUTES : UNLIMITED_COOLDOWN_MINUTES;

      const ridesRef = collection(db, "rideRequests");
      const qRef = query(
        ridesRef,
        where("userId", "==", userId),
        orderBy("createdAt", "desc"),
        limit(10)
      );

      const snap = await getDocs(qRef);
      if (snap.empty) return { allowed: true };

      let lastCompleted = null;
      snap.forEach((docSnap) => {
        if (lastCompleted) return;
        const data = docSnap.data();
        if (
          data.status === "completed" &&
          normalizePlanKey(data.membershipType) === normalizedPlan &&
          data.completedAt &&
          typeof data.completedAt.toDate === "function"
        ) {
          lastCompleted = data;
        }
      });

      if (!lastCompleted) return { allowed: true };

      const completedAt = lastCompleted.completedAt.toDate();
      const diffMs = Date.now() - completedAt.getTime();
      const diffMin = diffMs / 60000;
      if (diffMin >= coolMinutes) return { allowed: true };

      return {
        allowed: false,
        remainingMinutes: Math.ceil(coolMinutes - diffMin)
      };
    }

    function formatTripEstimate(data) {
      const estMinutes =
        data && typeof data.estimatedDurationMinutes === "number"
          ? data.estimatedDurationMinutes
          : null;
      if (!estMinutes) return "";
      if (estMinutes < 1) return "Trip under 1 minute.";
      if (estMinutes < 10) return `Estimated trip: ~${estMinutes.toFixed(1)} min.`;
      return `Estimated trip: about ${Math.round(estMinutes)} min.`;
    }

    function normalizeRiderStatus(data) {
      const status = (data?.status || "").toLowerCase();
      if (status === "driver_arrived") return "arrived_at_pickup";
      if (status === "in_progress") return "pickup_code_verified";
      return status;
    }

    function getStateElementByState(state) {
      switch (state) {
        case RIDER_STATES.SEARCHING:
          return riderStateElements.searching;
        case RIDER_STATES.DRIVER_TO_PICKUP:
          return riderStateElements.driverEta;
        case RIDER_STATES.PICKUP_PIN:
          return riderStateElements.pickupPin;
        case RIDER_STATES.IN_TRIP:
          return riderStateElements.inTrip;
        case RIDER_STATES.DROPOFF_PIN:
          return riderStateElements.dropoffPin;
        case RIDER_STATES.RATE_TIP:
          return riderStateElements.rateTip;
        case RIDER_STATES.THANKS:
          return riderStateElements.thanks;
        default:
          return null;
      }
    }

    function setRiderOverlayState(state) {
      riderOverlayState = state;
      if (state === RIDER_STATES.HIDDEN) {
        if (driverInfoStack) {
          driverInfoStack.style.display = "none";
        }
        if (driverMiniMapShell) {
          driverMiniMapShell.style.display = "none";
          setDriverMiniMapStatus("");
        }
        riderOverlay?.classList.remove("active");
        return;
      }

      Object.values(riderStateElements).forEach((el) => el?.classList.remove("active"));
      const target = getStateElementByState(state);
      if (target) {
        target.classList.add("active");
      }

      riderOverlay?.classList.add("active");

      if (driverInfoStack) {
        const needsDriverInfo =
          state === RIDER_STATES.DRIVER_TO_PICKUP || state === RIDER_STATES.IN_TRIP;
        if (needsDriverInfo) {
          const slot =
            state === RIDER_STATES.DRIVER_TO_PICKUP ? driverInfoSlotPickup : driverInfoSlotTrip;
          if (slot) {
            slot.appendChild(driverInfoStack);
            driverInfoStack.style.display = "flex";
            refreshDriverMiniMap();
          }
        } else {
          driverInfoStack.style.display = "none";
          if (driverMiniMapShell) {
            driverMiniMapShell.style.display = "none";
            setDriverMiniMapStatus("");
          }
        }
      }
    }

    function setOverlayCopy(title, subtitle) {
      if (riderOverlayTitle) riderOverlayTitle.textContent = title || "RideSync";
      if (riderOverlaySubtitle) riderOverlaySubtitle.textContent = subtitle || "";
    }

    function updateDriverModules(data) {
      renderDriverIdentity(data);
      renderVehicleSection(data);
      renderLicenseSection(data);
      updateDriverMiniMap(data);
      supportPanel?.classList.remove("active");
    }

    function formatPinValue(value) {
      if (value == null) return "----";
      const str = String(value).trim().toUpperCase();
      if (!str) return "----";
      return str.split("").join(" ");
    }

    function updatePickupPinDisplay(code) {
      if (riderPickupPinValue) {
        riderPickupPinValue.textContent = formatPinValue(code);
      }
    }

    function updateDropoffPinDisplay(code) {
      if (riderDropoffPinValue) {
        riderDropoffPinValue.textContent = formatPinValue(code);
      }
    }

    function hasRiderRating(data) {
      return (
        typeof data?.rating === "number" ||
        typeof data?.riderRating === "number"
      );
    }

    function handleRideSnapshot(rideId, data) {
      latestRideForOverlay = { rideId, data };
      const status = normalizeRiderStatus(data);
      const destinationLabel =
        data.toDestination || data.toAddress || data.destAddress || "Destination";

      if (status === "canceled_by_driver") {
        returnToHomeAfterRide(
          "Driver canceled your ride. You're back on the home screen.",
          true
        );
        return;
      }

      if (status === "canceled_by_rider") {
        returnToHomeAfterRide("Ride canceled.");
        return;
      }

      switch (status) {
        case "pending_driver":
        case "pending":
        case "pool_searching":
        case "pooled_pending_driver":
          setOverlayCopy("Syncing your ride", "Looking for a verified driver…");
          setRiderOverlayState(RIDER_STATES.SEARCHING);
          break;
        case "driver_assigned":
          updateDriverModules(data);
          setOverlayCopy("Driver en route", destinationLabel);
          setRiderOverlayState(RIDER_STATES.DRIVER_TO_PICKUP);
          break;
        case "arrived_at_pickup":
          updatePickupPinDisplay(getPickupCodeFromRide(data));
          setOverlayCopy("Share your pickup code", "Only give this to your driver.");
          setRiderOverlayState(RIDER_STATES.PICKUP_PIN);
          break;
        case "pickup_code_verified":
          updateDriverModules(data);
          riderTripEtaText.textContent =
            formatTripEstimate(data) || "Sit back and relax.";
          setOverlayCopy("On the way", destinationLabel);
          setRiderOverlayState(RIDER_STATES.IN_TRIP);
          break;
        case "arrived_at_dropoff":
          updateDropoffPinDisplay(getDropoffCodeFromRide(data));
          setOverlayCopy("Share your dropoff code", "Tell your driver to finish the ride.");
          setRiderOverlayState(RIDER_STATES.DROPOFF_PIN);
          break;
        case "dropoff_code_verified":
        case "completed":
          if (hasRiderRating(data)) {
            setOverlayCopy("All set", "Thanks for riding with RideSync.");
            setRiderOverlayState(RIDER_STATES.THANKS);
            setTimeout(() => returnToHomeAfterRide("Thanks for riding!"), 1800);
          } else {
            resetRatingForm();
            setOverlayCopy("Rate & tip", "Let us know how it went.");
            setRiderOverlayState(RIDER_STATES.RATE_TIP);
          }
          break;
        default:
          updateDriverModules(data);
          setOverlayCopy("Ride update", destinationLabel);
          setRiderOverlayState(RIDER_STATES.DRIVER_TO_PICKUP);
      }
    }

    function resetRatingForm() {
      selectedRating = 0;
      selectedTipValue = 0;
      tipIsCustom = false;
      ratingSubmitting = false;
      ratingError.textContent = "";
      riderFeedbackInput.value = "";
      tipCustomInput.value = "";
      tipCustomInput.style.display = "none";
      updateRatingButtons();
      const defaultTipButton = tipOptions?.querySelector(".tip-button[data-tip='0']");
      updateTipButtons(defaultTipButton);
    }

    function updateRatingButtons() {
      if (!ratingStarsContainer) return;
      ratingStarsContainer.querySelectorAll("button[data-rating]").forEach((btn) => {
        const value = Number(btn.dataset.rating);
        btn.classList.toggle("active", value <= selectedRating);
      });
    }

    function updateTipButtons(activeButton) {
      if (!tipOptions) return;
      tipOptions.querySelectorAll(".tip-button").forEach((btn) => {
        btn.classList.toggle("active", btn === activeButton);
      });
    }

    function handleRatingStarClick(event) {
      const button = event.target.closest("button[data-rating]");
      if (!button) return;
      const value = Number(button.dataset.rating);
      if (Number.isNaN(value)) return;
      selectedRating = value;
      updateRatingButtons();
    }

    function handleTipButtonClick(event) {
      const button = event.target.closest(".tip-button");
      if (!button) return;
      updateTipButtons(button);
      const tipValue = button.dataset.tip;
      if (tipValue === "custom") {
        tipIsCustom = true;
        tipCustomInput.style.display = "block";
        tipCustomInput.focus();
        selectedTipValue = 0;
      } else {
        tipIsCustom = false;
        tipCustomInput.style.display = "none";
        tipCustomInput.value = "";
        selectedTipValue = Number(tipValue);
      }
    }

    async function submitRatingAndTip() {
      ratingError.textContent = "";
      if (ratingSubmitting) return;
      if (!currentRideId) {
        ratingError.textContent = "Ride not found.";
        return;
      }
      if (selectedRating < 1) {
        ratingError.textContent = "Select a rating.";
        return;
      }
      let tipValue = selectedTipValue;
      if (tipIsCustom) {
        const parsed = Number(tipCustomInput.value);
        if (Number.isNaN(parsed) || parsed < 0) {
          ratingError.textContent = "Enter a valid custom tip.";
          return;
        }
        tipValue = parsed;
      }
      ratingSubmitting = true;
      submitRatingButton.disabled = true;
      try {
        const updates = {
          rating: selectedRating,
          riderRating: selectedRating,
          riderFeedback: riderFeedbackInput.value.trim() || null,
          tip: tipValue,
          tipAmount: tipValue,
          tipCurrency: "USD",
          riderRatedAt: serverTimestamp(),
          riderRated: true
        };
        await updateDoc(doc(db, "rideRequests", currentRideId), updates);
        setOverlayCopy("Thank you!", "Sending your feedback now.");
        setRiderOverlayState(RIDER_STATES.THANKS, { forceReveal: true });
        setTimeout(() => returnToHomeAfterRide("Thanks for riding!"), 2000);
      } catch (err) {
        console.error("submitRating error", err);
        ratingError.textContent = err.message || "Could not submit rating.";
      } finally {
        ratingSubmitting = false;
        submitRatingButton.disabled = false;
      }
    }

    function getPickupCodeFromRide(ride) {
      return (
        ride?.pickupCode ??
        ride?.pickup_code ??
        ride?.pickupPin ??
        ride?.pickupPIN ??
        ride?.boardingCode ??
        null
      );
    }

    function getDropoffCodeFromRide(ride) {
      return (
        ride?.dropoffCode ??
        ride?.dropoff_code ??
        ride?.dropoffPin ??
        ride?.dropoffPIN ??
        ride?.dropoffBoardingCode ??
        null
      );
    }

    function startRideStatusWatcher(rideId) {
      if (currentRideWatcher) {
        currentRideWatcher();
        currentRideWatcher = null;
      }
      const rideRef = doc(db, "rideRequests", rideId);
      currentRideWatcher = onSnapshot(rideRef, (snap) => {
        if (!snap.exists()) return;
        const data = snap.data();
        currentRideStatus = data.status || null;
        updateCancelButtonVisibility();
        handleRideSnapshot(rideId, data);
      });
    }
      
      function hideGroupQr() {
      if (groupQrSection) {
        groupQrSection.style.display = "none";
      }
      if (groupOccupancyLabel) {
        groupOccupancyLabel.textContent = "";
      }
      if (groupOccupancyUnsub) {
        groupOccupancyUnsub();
        groupOccupancyUnsub = null;
      }
    }

    function showGroupQr(rideId) {
      if (!groupQrSection || !groupQrCanvas) return;
      const joinUrl = `${window.location.origin}?join=${encodeURIComponent(rideId)}`;
      if (!groupQr) {
        groupQr = new QRious({
          element: groupQrCanvas,
          size: 140,
          value: joinUrl
        });
      } else {
        groupQr.set({ value: joinUrl });
      }
      groupQrSection.style.display = "block";
      startGroupOccupancyWatcher(rideId);
    }

    function startGroupOccupancyWatcher(rideId) {
      if (groupOccupancyUnsub) {
        groupOccupancyUnsub();
        groupOccupancyUnsub = null;
      }
      const rideRef = doc(db, "rideRequests", rideId);
      groupOccupancyUnsub = onSnapshot(rideRef, (snap) => {
        if (!snap.exists()) return;
        const data = snap.data();
        const cur = data.currentRiderCount || 1;
        const max = data.maxRiders || 1;
        if (groupOccupancyLabel) {
          groupOccupancyLabel.textContent = `Group: ${cur} of ${max} riders.`;
        }
      });
    }

      cancelRideButton.addEventListener("click", async () => {
        cancelError.textContent = "";
        profileMessage.textContent = "";
        if (!currentRideId) {
          cancelError.textContent = "No active ride to cancel.";
          return;
        }

        if (currentRideStatus && !riderCancelableStatuses.has(currentRideStatus)) {
          cancelError.textContent = "Ride can no longer be canceled.";
          return;
        }

        try {
          const rideRef = doc(db, "rideRequests", currentRideId);
          await updateDoc(rideRef, {
            status: "canceled_by_rider",
            paymentStatus: "canceled",
            canceledAt: serverTimestamp()
          });

          returnToHomeAfterRide("Ride canceled, you won't be charged.");
        } catch (err) {
          console.error(err);
          cancelError.textContent = "Could not cancel ride.";
        }
      });

    // Rider overlay buttons
    if (ratingStarsContainer) {
      ratingStarsContainer.addEventListener("click", handleRatingStarClick);
    }
    if (tipOptions) {
      tipOptions.addEventListener("click", handleTipButtonClick);
    }
    if (submitRatingButton) {
      submitRatingButton.addEventListener("click", submitRatingAndTip);
    }

    if (supportCallButton) {
      supportCallButton.href = SUPPORT_TEL_LINK;
    }
    if (supportTextButton) {
      supportTextButton.href = SUPPORT_SMS_LINK;
    }

    if (contactDriverBtn) {
      contactDriverBtn.addEventListener("click", () => {
        if (!supportPanel) return;
        supportPanel.classList.add("active");
        supportPanel.scrollIntoView({ behavior: "smooth", block: "start" });
      });
    }

    if (supportBackButton) {
      supportBackButton.addEventListener("click", () => {
        supportPanel?.classList.remove("active");
      });
    }

    // === RIDE SYNC STRIPE: START membership overlay logic ===
    const overlayFocusMemory = new WeakMap();
    const focusableOverlaySelector =
      "[data-default-focus], button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex='-1'])";

    function setMembershipMessage(text) {
      if (membershipCardMessage) {
        membershipCardMessage.textContent = text || "";
      }
    }

    function toggleOverlay(el, show, focusTarget) {
      if (!el) return;
      if (show) {
        if (document.activeElement instanceof HTMLElement) {
          overlayFocusMemory.set(el, document.activeElement);
        } else {
          overlayFocusMemory.delete(el);
        }
        el.classList.add("active");
        el.setAttribute("aria-hidden", "false");
        el.removeAttribute("inert");
        const preferredTarget =
          (focusTarget && typeof focusTarget.focus === "function" && focusTarget) ||
          el.querySelector("[data-default-focus]") ||
          el.querySelector(focusableOverlaySelector);
        if (preferredTarget && typeof preferredTarget.focus === "function") {
          requestAnimationFrame(() => preferredTarget.focus());
        }
      } else {
        el.classList.remove("active");
        el.setAttribute("aria-hidden", "true");
        el.setAttribute("inert", "");
        if (
          el.contains(document.activeElement) &&
          document.activeElement instanceof HTMLElement &&
          typeof document.activeElement.blur === "function"
        ) {
          document.activeElement.blur();
        }
        const previousFocus = overlayFocusMemory.get(el);
        overlayFocusMemory.delete(el);
        if (previousFocus && typeof previousFocus.focus === "function") {
          previousFocus.focus();
        }
      }
    }

    function resetMembershipSelectionState() {
      membershipSelectionOptions?.forEach?.((node) => {
        node.classList.remove("active");
      });
      if (membershipSelectionError) {
        membershipSelectionError.textContent = "";
      }
      pendingMembershipPlanId = null;
    }

    function openMembershipSelectionOverlayUI() {
      if (!auth.currentUser) {
        setMembershipMessage("Log in to manage your membership.");
        return;
      }
      resetMembershipSelectionState();
      toggleOverlay(membershipSelectionOverlay, true, membershipSelectionClose);
    }

    function closeMembershipSelectionOverlayUI() {
      toggleOverlay(membershipSelectionOverlay, false);
      if (membershipSelectionError) {
        membershipSelectionError.textContent = "";
      }
    }

    function selectMembershipPlan(planId) {
      pendingMembershipPlanId = planId;
      membershipSelectionOptions?.forEach?.((node) => {
        const isActive = node.dataset.membershipOption === planId;
        node.classList.toggle("active", isActive);
      });
      if (membershipSelectionError) {
        membershipSelectionError.textContent = "";
      }
    }

    function resizeMembershipSignatureCanvas() {
      if (!membershipSignatureCanvas) return;
      const rect = membershipSignatureCanvas.getBoundingClientRect();
      const ratio = window.devicePixelRatio || 1;
      membershipSignatureCanvas.width = rect.width * ratio;
      membershipSignatureCanvas.height = rect.height * ratio;
      membershipSignatureCtx = membershipSignatureCanvas.getContext("2d");
      membershipSignatureCtx.setTransform(1, 0, 0, 1, 0, 0);
      membershipSignatureCtx.scale(ratio, ratio);
      membershipSignatureCtx.lineWidth = 2.4;
      membershipSignatureCtx.strokeStyle = "#f97316";
      membershipSignatureCtx.lineCap = "round";
      membershipSignatureCtx.lineJoin = "round";
      membershipSignatureCtx.clearRect(0, 0, rect.width, rect.height);
      membershipSignatureHasInk = false;
      updateMembershipTermsAcceptState();
    }

    function updateMembershipTermsAcceptState() {
      if (!membershipTermsAccept) return;
      const canAccept =
        membershipTermsCheckbox?.checked && membershipSignatureHasInk && !membershipTermsProcessing;
      membershipTermsAccept.disabled = !canAccept;
    }

    function clearMembershipSignatureCanvas() {
      if (!membershipSignatureCanvas || !membershipSignatureCtx) return;
      membershipSignatureCtx.clearRect(
        0,
        0,
        membershipSignatureCanvas.width,
        membershipSignatureCanvas.height
      );
      membershipSignatureHasInk = false;
      updateMembershipTermsAcceptState();
    }

    function attachSignatureListeners() {
      if (!membershipSignatureCanvas) return;
      const getPoint = (evt) => {
        const rect = membershipSignatureCanvas.getBoundingClientRect();
        const clientX =
          evt.touches && evt.touches.length ? evt.touches[0].clientX : evt.clientX;
        const clientY =
          evt.touches && evt.touches.length ? evt.touches[0].clientY : evt.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
      };
      const start = (evt) => {
        if (!membershipSignatureCtx) return;
        evt.preventDefault();
        membershipSignatureDrawing = true;
        const point = getPoint(evt);
        membershipSignatureCtx.beginPath();
        membershipSignatureCtx.moveTo(point.x, point.y);
      };
      const move = (evt) => {
        if (!membershipSignatureDrawing || !membershipSignatureCtx) return;
        evt.preventDefault();
        const point = getPoint(evt);
        membershipSignatureCtx.lineTo(point.x, point.y);
        membershipSignatureCtx.stroke();
        membershipSignatureHasInk = true;
        updateMembershipTermsAcceptState();
      };
      const end = () => {
        if (!membershipSignatureDrawing || !membershipSignatureCtx) return;
        membershipSignatureDrawing = false;
        membershipSignatureCtx.closePath();
      };
      ["mousedown", "touchstart"].forEach((eventName) => {
        membershipSignatureCanvas.addEventListener(eventName, start, { passive: false });
      });
      ["mousemove", "touchmove"].forEach((eventName) => {
        membershipSignatureCanvas.addEventListener(eventName, move, { passive: false });
      });
      ["mouseup", "mouseleave", "touchend", "touchcancel"].forEach((eventName) => {
        membershipSignatureCanvas.addEventListener(eventName, end, { passive: false });
      });
    }

    function openMembershipTermsOverlayUI() {
      if (!pendingMembershipPlanId) return;
      if (membershipTermsCheckbox) {
        membershipTermsCheckbox.checked = false;
      }
      if (membershipTermsError) {
        membershipTermsError.textContent = "";
      }
      toggleOverlay(membershipTermsOverlay, true, membershipTermsClose);
      requestAnimationFrame(() => {
        resizeMembershipSignatureCanvas();
      });
      updateMembershipTermsAcceptState();
    }

    function closeMembershipTermsOverlayUI() {
      toggleOverlay(membershipTermsOverlay, false);
      membershipTermsProcessing = false;
      updateMembershipTermsAcceptState();
    }

    async function persistMembershipTermsSignature() {
      const user = auth.currentUser;
      if (!user) {
        throw new Error("Log in to continue.");
      }
      if (!membershipSignatureCanvas || !membershipSignatureHasInk) {
        throw new Error("Sign the terms to continue.");
      }
      const blob = await new Promise((resolve, reject) => {
        membershipSignatureCanvas.toBlob((generatedBlob) => {
          if (generatedBlob) {
            resolve(generatedBlob);
          } else {
            reject(new Error("Unable to capture signature."));
          }
        }, "image/png");
      });
      const storagePath = `membershipSignatures/${user.uid}/${Date.now()}.png`;
      const signatureRef = ref(storage, storagePath);
      await uploadBytes(signatureRef, blob, { contentType: "image/png" });
      const downloadUrl = await getDownloadURL(signatureRef);
      await setDoc(
        doc(db, "users", user.uid),
        {
          membershipTermsAccepted: true,
          membershipTermsAcceptedAt: serverTimestamp(),
          membershipTermsVersion: "v1",
          membershipSignatureImageUrl: downloadUrl,
        },
        { merge: true }
      );
      return downloadUrl;
    }

    async function startMembershipSubscriptionFlow(planId) {
      if (!STRIPE_ENABLED) {
        throw new Error("Stripe payments are not available right now.");
      }
      const response = await createMembershipSubscriptionIntentFn({ planId });
      const data = response?.data || {};
      if (!data.clientSecret || !data.subscriptionId) {
        throw new Error("Unable to start Stripe subscription.");
      }
      const planLabel =
        MEMBERSHIP_PLAN_COPY[planId]?.label || formatMembershipPlanLabel(planId);
      await openPaymentOverlay({
        title: `Activate ${planLabel}`,
        subtitle: "Enter payment details to start your subscription.",
        confirmLabel: "Start subscription",
        clientSecret: data.clientSecret,
        context: {
          type: "membershipSubscription",
          subscriptionId: data.subscriptionId,
          planId,
        },
      });
      setMembershipMessage("Complete the payment to finish upgrading.");
    }

    async function handleMembershipTermsAccept() {
      if (!pendingMembershipPlanId) {
        if (membershipTermsError) {
          membershipTermsError.textContent = "Choose a membership first.";
        }
        return;
      }
      if (membershipTermsProcessing) return;
      membershipTermsProcessing = true;
      updateMembershipTermsAcceptState();
      if (membershipTermsError) {
        membershipTermsError.textContent = "";
      }
      try {
        await persistMembershipTermsSignature();
        await startMembershipSubscriptionFlow(pendingMembershipPlanId);
        closeMembershipTermsOverlayUI();
      } catch (err) {
        console.error("Membership terms accept", err);
        if (membershipTermsError) {
          membershipTermsError.textContent =
            err.message || "Could not continue to payment.";
        }
      } finally {
        if (membershipTermsOverlay?.classList.contains("active")) {
          membershipTermsProcessing = false;
          updateMembershipTermsAcceptState();
        }
      }
    }

    async function handleMembershipSwitchToBasic() {
      const user = auth.currentUser;
      if (!user) {
        setMembershipMessage("Log in to manage your membership.");
        return;
      }
      setMembershipMessage("");
      try {
        await callApplyMembershipPlan({ plan: "basic" });
        setMembershipMessage("You're back on the Basic plan.");
        await loadUserProfile(user.uid, user.email);
        closeMembershipSelectionOverlayUI();
        closeMembershipTermsOverlayUI();
      } catch (err) {
        console.error("Switch to basic", err);
        setMembershipMessage(err.message || "Could not switch to Basic.");
      }
    }

    membershipChangeButton?.addEventListener("click", () => {
      openMembershipSelectionOverlayUI();
    });
    membershipSelectionClose?.addEventListener("click", closeMembershipSelectionOverlayUI);
    membershipSelectionOverlay?.addEventListener("click", (evt) => {
      if (evt.target === membershipSelectionOverlay) {
        closeMembershipSelectionOverlayUI();
      }
    });
    membershipSelectionOptions?.forEach?.((node) => {
      node.addEventListener("click", () => {
        selectMembershipPlan(node.dataset.membershipOption);
      });
    });
    membershipSelectionContinue?.addEventListener("click", () => {
      if (!pendingMembershipPlanId) {
        if (membershipSelectionError) {
          membershipSelectionError.textContent = "Choose a plan to continue.";
        }
        return;
      }
      closeMembershipSelectionOverlayUI();
      openMembershipTermsOverlayUI();
    });
    membershipSelectionBasic?.addEventListener("click", handleMembershipSwitchToBasic);
    membershipTermsClose?.addEventListener("click", closeMembershipTermsOverlayUI);
    membershipTermsOverlay?.addEventListener("click", (evt) => {
      if (evt.target === membershipTermsOverlay) {
        closeMembershipTermsOverlayUI();
      }
    });
    membershipTermsCheckbox?.addEventListener("change", updateMembershipTermsAcceptState);
    membershipSignatureClear?.addEventListener("click", () => {
      clearMembershipSignatureCanvas();
      if (membershipTermsError) {
        membershipTermsError.textContent = "";
      }
    });
    membershipTermsAccept?.addEventListener("click", handleMembershipTermsAccept);
    attachSignatureListeners();
    window.addEventListener("resize", () => {
      if (membershipTermsOverlay?.classList.contains("active")) {
        resizeMembershipSignatureCanvas();
      }
    });
    // === RIDE SYNC STRIPE: END membership overlay logic ===

    if (paymentOverlayClose) {
      paymentOverlayClose.addEventListener("click", () => {
        const context = activePaymentContext;
        closePaymentOverlay();
        if (context?.type === "ride") {
          profileMessage.textContent = "Ride payment canceled. Ride not requested.";
        } else if (context?.type === "membership" && membershipCardMessage) {
          membershipCardMessage.textContent = "Membership payment canceled.";
        }
      });
    }

    if (paymentOverlayConfirm) {
      paymentOverlayConfirm.addEventListener("click", confirmActivePayment);
    }

    if (paymentOverlay) {
      paymentOverlay.addEventListener("click", (event) => {
        if (event.target === paymentOverlay) {
          const context = activePaymentContext;
          closePaymentOverlay();
          if (context?.type === "ride") {
            profileMessage.textContent = "Ride payment canceled. Ride not requested.";
          } else if (context?.type === "membership" && membershipCardMessage) {
            membershipCardMessage.textContent = "Membership payment canceled.";
          }
        }
      });
    }

    async function ensureStripeInstance() {
      if (!STRIPE_ENABLED) {
        throw new Error("Stripe payments are not available right now.");
      }
      await loadStripeJs();
      if (!window.Stripe) {
        throw new Error("Stripe.js is not available.");
      }
      if (!stripeInstance) {
        stripeInstance = window.Stripe(STRIPE_PUBLISHABLE_KEY);
      }
      return stripeInstance;
    }

    async function mountStripePaymentElement(clientSecret) {
      if (!paymentElementContainer) {
        throw new Error("Payment UI is unavailable.");
      }
      const stripe = await ensureStripeInstance();
      if (stripePaymentElement) {
        stripePaymentElement.unmount();
        stripePaymentElement = null;
      }
      stripeElements = stripe.elements({ clientSecret });
      stripePaymentElement = stripeElements.create("payment");
      stripePaymentElement.mount(paymentElementContainer);
    }

    async function openPaymentOverlay(options = {}) {
      if (!options.clientSecret) {
        throw new Error("Stripe client secret missing.");
      }
      await mountStripePaymentElement(options.clientSecret);
      activePaymentContext = options.context || null;
      if (paymentOverlayTitle) {
        paymentOverlayTitle.textContent = options.title || "Complete payment";
      }
      if (paymentOverlaySubtitle) {
        paymentOverlaySubtitle.textContent = options.subtitle || "";
      }
      if (paymentOverlayConfirm) {
        paymentOverlayConfirm.textContent = options.confirmLabel || "Pay now";
        paymentOverlayConfirm.disabled = false;
      }
      if (paymentOverlayMessage) {
        paymentOverlayMessage.textContent = "";
      }
      paymentOverlay?.classList.add("active");
      paymentOverlay?.setAttribute("aria-hidden", "false");
    }

    function closePaymentOverlay() {
      if (stripePaymentElement) {
        stripePaymentElement.unmount();
        stripePaymentElement = null;
      }
      stripeElements = null;
      activePaymentContext = null;
      paymentOverlay?.classList.remove("active");
      paymentOverlay?.setAttribute("aria-hidden", "true");
      if (paymentOverlayMessage) {
        paymentOverlayMessage.textContent = "";
      }
    }

    async function confirmActivePayment() {
      if (!activePaymentContext) return;
      if (paymentOverlayMessage) {
        paymentOverlayMessage.textContent = "";
      }
      if (paymentOverlayConfirm) {
        paymentOverlayConfirm.disabled = true;
      }

      try {
        const stripe = await ensureStripeInstance();
        const result = await stripe.confirmPayment({
          elements: stripeElements,
          redirect: "if_required",
        });
        if (result.error) {
          throw new Error(result.error.message || "Payment failed.");
        }
        if (!result.paymentIntent || result.paymentIntent.status !== "succeeded") {
          throw new Error("Payment did not complete.");
        }
        await handlePaymentSuccess(result.paymentIntent, activePaymentContext);
        closePaymentOverlay();
      } catch (err) {
        console.error("confirmActivePayment", err);
        if (paymentOverlayMessage) {
          paymentOverlayMessage.textContent =
            err.message || "Unable to process payment.";
        }
        if (paymentOverlayConfirm) {
          paymentOverlayConfirm.disabled = false;
        }
      }
    }

    async function activateRideAfterCreation(rideId, ridePayload) {
      currentRideId = rideId;
      startRideStatusWatcher(rideId);
      updateCancelButtonVisibility();
      if (ridePayload?.isGroupRide) {
        showGroupQr(rideId);
      } else {
        hideGroupQr();
      }
      if (ridePayload?.poolType === "uofa") {
        startPoolGroupWatcher(rideId);
      }
      profileMessage.textContent = "Syncing your ride.";
      profileError.textContent = "";
      showLoadingView();
    }

    async function handlePaymentSuccess(paymentIntent, context) {
      if (context?.type === "membershipSubscription") {
        const finalizeResponse = await finalizeMembershipSubscriptionFn({
          subscriptionId: context.subscriptionId,
        });
        const status = finalizeResponse?.data?.status || "active";
        if (status === "active") {
          setMembershipMessage("Membership updated!");
        } else {
          setMembershipMessage(`Subscription status: ${status}`);
        }
        const user = auth.currentUser;
        if (user) {
          await loadUserProfile(user.uid, user.email);
        }
        return;
      }

      if (context?.type === "membership") {
        await callApplyMembershipPlan({
          plan: context.plan,
          paymentIntentId: paymentIntent.id,
        });
        setMembershipMessage("Membership updated!");
        const user = auth.currentUser;
        if (user) {
          await loadUserProfile(user.uid, user.email);
        }
        return;
      }

      if (context?.type === "ride") {
        const response = await finalizeRidePaymentFn({
          pendingId: context.pendingId,
          paymentIntentId: paymentIntent.id,
        });
        const rideId = response?.data?.rideId;
        if (!rideId) {
          throw new Error("Ride could not be created after payment.");
        }
        await activateRideAfterCreation(rideId, context.ridePayload);
      }
    }

    async function startRidePaymentFlow(ridePayload) {
      const response = await createRidePaymentIntentFn({ ride: ridePayload });
      const data = response?.data || {};
      if (data.skipPayment && data.rideId) {
        await activateRideAfterCreation(data.rideId, ridePayload);
        return;
      }
      if (!STRIPE_ENABLED) {
        throw new Error("Stripe payments are not available right now.");
      }
      if (!data.clientSecret || !data.pendingId) {
        throw new Error("Unable to start Stripe payment for this ride.");
      }
      const formattedTotal = formatCurrencyFromCents(
        data.amountCents,
        data.currency
      );
      let subtitle = `Pay ${formattedTotal} to request this ride.`;
      if (data.geofenceContext?.geofenceName) {
        subtitle =
          data.geofenceContext.amountCents > 0
            ? `Membership covers the base fare. Pay ${formattedTotal} for the out-of-zone surcharge.`
            : subtitle;
      }
      await openPaymentOverlay({
        title: "Confirm ride payment",
        subtitle,
        confirmLabel: `Pay ${formattedTotal}`,
        clientSecret: data.clientSecret,
        context: {
          type: "ride",
          pendingId: data.pendingId,
          paymentIntentId: data.paymentIntentId,
          ridePayload,
        },
      });
      profileMessage.textContent =
        "Complete the payment to finish syncing your ride.";
      profileError.textContent = "";
    }

    async function handleNewRide() {
      const user = auth.currentUser;
      if (!user) return;

      profileError.textContent = "";
      clearPoolGroupUI();
      hideGroupQr();

      if (!destinationLatLng || !lastRideMetrics || !lastRideMetrics.fareBreakdown) {
        profileError.textContent = "Set destination and wait for fare estimate first.";
        updateRouteAndFare();
        return;
      }

      const plan = normalizePlanKey(
        currentUserProfile?.membershipType || currentUserProfile?.membership || "basic"
      );
      const membershipStatus = currentUserProfile?.membershipStatus || "none";
      const isStudent = !!currentUserProfile?.isStudent;
      const uofaVerified = !!currentUserProfile?.uofaVerified;
      const poolGender = normalizePoolGender(currentUserProfile?.gender);
      const genderPoolEligible = !!poolGender;
      const numRiders = parseInt(numRidersEl.value || "1", 10);
      const inHomeZone = !!lastRideMetrics.inHomeZone;

      // 🔐 U of A pooling strict eligibility
      const uofaPoolEligible =
        plan === "uofa_unlimited" &&
        isStudent &&
        uofaVerified &&
        genderPoolEligible &&
        inHomeZone;

      const fare = lastRideMetrics.fareBreakdown;
      const totalValue = Number.isFinite(fare.total) ? fare.total : 0;
      const totalCents = Math.max(0, Math.round(totalValue * 100));

      const cd = await checkCooldown(user.uid, plan);
      if (cd.allowed === false) {
        profileError.textContent = `You can request another ride in about ${cd.remainingMinutes} min.`;
        return;
      }

      let poolType = null;
      let status = "pending_driver";

      if (uofaPoolEligible && numRiders === 1) {
        poolType = "uofa";
        status = "pool_searching";
      }

      const destAddress = destinationEl.value.trim() || (lastDestinationPlace?.formatted_address || "");

      const riderName =
        currentUserProfile?.fullName ||
        currentUserProfile?.name ||
        currentUserProfile?.displayName ||
        (currentUserProfile?.email
          ? currentUserProfile.email.split("@")[0]
          : "Rider");

      const riderPhone =
        currentUserProfile?.phone || currentUserProfile?.phoneNumber || "";
      const riderPhotoUrl =
        currentUserProfile?.profilePicUrl ||
        currentUserProfile?.photoURL ||
        null;

      const maxRiders = numRiders;
      const isGroupRide = maxRiders > 1;
      const pickupCode = generateRidePin();
      const dropoffCode = generateRidePin();
      const pickupLocationLiteral = currentLocation
        ? { lat: currentLocation.lat, lng: currentLocation.lng }
        : null;
      const dropoffLocationLiteral = latLngToLiteral(destinationLatLng);
      if (!pickupLocationLiteral || !dropoffLocationLiteral) {
        profileError.textContent = "Missing pickup or dropoff location.";
        return;
      }

      const rideBase = {
        userId: user.uid,
        startedByUserId: user.uid,
        createdAt: serverTimestamp(),
        membershipType: plan,
        membershipStatus,
        isStudent,
        uofaVerified,
        gender: poolGender,
        uofaPoolEligible,
        riderName,
        riderPhone,
        riderProfilePicUrl: riderPhotoUrl,
        riderPhotoUrl,
        riderAvatarUrl: riderPhotoUrl,
        riderImageUrl: riderPhotoUrl,
        isGroupRide,
        maxRiders,
        currentRiderCount: 1,
        groupId: null,
        poolType,
        fromLocation: currentLocation || null,
        pickupLocation: pickupLocationLiteral,
        dropoffLocation: dropoffLocationLiteral,
        toDestination: destAddress || null,
        inHomeZone,
        estimatedDurationMinutes: lastRideMetrics.durationMinutes
          ? +lastRideMetrics.durationMinutes.toFixed(1)
          : null,
        distanceMeters: lastRideMetrics.distanceMeters || null,
        fare,
        totalCents,
        pickupCode,
        pickupPin: pickupCode,
        dropoffCode,
        dropoffPin: dropoffCode
      };

      try {
        const ridePaymentPayload = { ...rideBase, status };
        delete ridePaymentPayload.createdAt;
        await startRidePaymentFlow(ridePaymentPayload);
      } catch (err) {
        console.error("New ride error", err);
        profileError.textContent = err.message || "Could not sync ride / payment.";
      }
    }

    async function handleJoinRide() {
      const user = auth.currentUser;
      if (!user || !joinTargetRide) {
        profileError.textContent = "Unable to join this ride.";
        return;
      }

      profileError.textContent = "";
      cancelError.textContent = "";

      try {
        const plan = normalizePlanKey(
          currentUserProfile?.membershipType ||
            currentUserProfile?.membership ||
            "basic"
        );
        const riderGender = normalizePoolGender(currentUserProfile?.gender);
        if (!riderGender) {
          profileError.textContent =
            "Set your profile gender to Male or Female to join pooling rides.";
          return;
        }
        const targetGender = normalizePoolGender(joinTargetRide?.gender);
        if (targetGender && targetGender !== riderGender) {
          profileError.textContent =
            "You can only join riders who share your gender.";
          return;
        }

        const cooldown = await checkCooldown(user.uid, plan);
        if (cooldown.allowed === false) {
          profileError.textContent = `You can request another ride in about ${cooldown.remainingMinutes} min.`;
          return;
        }

        const hostRef = doc(db, "rideRequests", joinTargetRide.id);
        const newRideRef = doc(collection(db, "rideRequests"));
        let createdRideId = null;

        await runTransaction(db, async (tx) => {
          const hostSnap = await tx.get(hostRef);
          if (!hostSnap.exists()) {
            throw new Error("This group ride is no longer available.");
          }
          const host = hostSnap.data();
          const max = host.maxRiders || 1;
          const currentCount = host.currentRiderCount || 1;
          if (currentCount >= max) {
            throw new Error("This group ride is already full.");
          }

          const normalizeHostPin = (value) =>
            value == null ? "" : String(value).trim().toUpperCase();
          const pickupCode =
            normalizeHostPin(
              host.pickupCode ||
                host.pickupPin ||
                host.pickupPIN ||
                host.boardingCode
            ) || generateRidePin();
          const dropoffCode =
            normalizeHostPin(
              host.dropoffCode ||
                host.dropoffPin ||
                host.dropoffPIN ||
                host.dropoffBoardingCode
            ) || generateRidePin();

          const isStudent = !!currentUserProfile?.isStudent;
          const uofaVerified = !!currentUserProfile?.uofaVerified;
          const hostGender = normalizePoolGender(host.gender);
          if (!hostGender || hostGender !== riderGender) {
            throw new Error(
              "This group ride can only include riders with the same gender."
            );
          }
          const inHomeZone = !!host.inHomeZone;
          const minutes = host.estimatedDurationMinutes || 0;
          const fare = computeFareForMembership(plan, minutes, inHomeZone);
          const total = Number.isFinite(fare.total) ? fare.total : 0;
          const paymentIsIncluded = plan !== "basic" && inHomeZone;

          const riderName =
            currentUserProfile?.fullName ||
            currentUserProfile?.name ||
            currentUserProfile?.displayName ||
            (currentUserProfile?.email
              ? currentUserProfile.email.split("@")[0]
              : "Rider");
          const riderPhone =
            currentUserProfile?.phone || currentUserProfile?.phoneNumber || "";
          const riderPhotoUrl =
            currentUserProfile?.profilePicUrl ||
            currentUserProfile?.photoURL ||
            null;

          const groupId = host.groupId || hostSnap.id;
          const nextCount = Math.min(max, currentCount + 1);
          const poolType = host.poolType || null;
          const paymentMethod = paymentIsIncluded
            ? poolType === "uofa"
              ? "included_pool"
              : "included"
            : "stripe";
          const paymentStatus = paymentIsIncluded ? "included" : "preauthorized";

          const driverFields = {};
          if (host.driverId) {
            Object.keys(host).forEach((key) => {
              if (key.startsWith("driver")) {
                driverFields[key] = host[key];
              }
            });
            if (host.assignedAt) {
              driverFields.assignedAt = host.assignedAt;
            }
          }

          const joinRideDoc = {
            userId: user.uid,
            startedByUserId: host.startedByUserId || host.userId || user.uid,
            createdAt: serverTimestamp(),
            membershipType: plan,
            membershipStatus: currentUserProfile?.membershipStatus || "none",
            isStudent,
            uofaVerified,
            gender: riderGender,
            riderName,
            riderPhone,
            riderProfilePicUrl: riderPhotoUrl,
            riderPhotoUrl,
            riderAvatarUrl: riderPhotoUrl,
            riderImageUrl: riderPhotoUrl,
            isGroupRide: true,
            maxRiders: host.maxRiders || 1,
            currentRiderCount: nextCount,
            groupId,
            poolType,
            fromLocation: host.fromLocation || null,
            toDestination: host.toDestination || null,
            inHomeZone,
            estimatedDurationMinutes: host.estimatedDurationMinutes || null,
            distanceMeters: host.distanceMeters || null,
            fare,
            pickupCode,
            pickupPin: pickupCode,
            dropoffCode,
            dropoffPin: dropoffCode,
            status: host.status || "pending_driver",
            paymentMethod,
            paymentStatus,
            stripeAmount: paymentIsIncluded ? null : total,
            joinedExistingRideId: hostSnap.id,
            ...driverFields
          };

          tx.set(newRideRef, joinRideDoc);
          tx.update(hostRef, {
            currentRiderCount: nextCount
          });

          createdRideId = newRideRef.id;
        });

        currentRideId = createdRideId;
        startRideStatusWatcher(createdRideId);
        updateCancelButtonVisibility();
        hideGroupQr();
        showLoadingView();
      } catch (err) {
        console.error("Join ride error", err);
        profileError.textContent = err.message || "Could not join group ride.";
      }
    }

    syncButton.addEventListener("click", async () => {
      if (joinMode && joinTargetRide) {
        await handleJoinRide();
      } else {
        await handleNewRide();
      }
    });

    async function enterJoinMode(rideId) {
      try {
        const hostRef = doc(db, "rideRequests", rideId);
        const snap = await getDoc(hostRef);
        if (!snap.exists()) {
          console.warn("Join ride not found");
          return;
        }
        const host = snap.data();
        joinMode = true;
        joinTargetRide = { id: snap.id, ...host };

        joinBanner.style.display = "block";
        const cur = host.currentRiderCount || 1;
        const max = host.maxRiders || 1;
        joinBannerText.textContent = `Joining group ride to "${host.toDestination || "destination"}". Group: ${cur} of ${max} riders. You will join as 1 rider. If you need an extra stop, tell your driver when picked up.`;

        ridersSection.style.display = "none";
        numRidersEl.value = "1";
        numRidersEl.disabled = true;

        if (host.toDestination) {
          destinationEl.value = host.toDestination;
        }
        updateSyncButtonLabel();
      } catch (err) {
        console.error("Failed to enter join mode", err);
      }
    }

      function ensureBackgroundMapReady() {
        if (googleMapsLoadFailed) return;
        if (map) return;
        if (window.google && google.maps) {
          initMapOnce();
          return;
        }
        setTimeout(ensureBackgroundMapReady, 600);
      }

      function trySetupAutocompleteEarly() {
        if (googleMapsLoadFailed) return;
        if (!window.google || !google.maps || !google.maps.places) {
          setTimeout(trySetupAutocompleteEarly, 800);
          return;
        }
        setupDestinationAutocomplete();
      }

      ensureBackgroundMapReady();
      trySetupAutocompleteEarly();
  </script>
</body>
</html>